<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Spot The Sun - Terrasses ensoleillÃ©es Ã  Paris</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="Trouve les terrasses ensoleillÃ©es Ã  Paris en temps rÃ©el. GÃ©olocalisation, mÃ©tÃ©o live et prÃ©visions horaires.">
  <meta name="theme-color" content="#f59e0b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Spot The Sun">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-TileColor" content="#f59e0b">
  <meta name="msapplication-tap-highlight" content="no">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%23fbbf24' width='180' height='180' rx='40'/><text x='90' y='125' text-anchor='middle' font-size='100'>â˜€ï¸</text></svg>">
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><text x='16' y='24' text-anchor='middle' font-size='24'>â˜€ï¸</text></svg>">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .glow-yellow { box-shadow: 0 0 20px rgba(255, 215, 0, 0.6); }
    .pulse-glow { animation: pulseGlow 2s ease-in-out infinite; }
    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.4); }
      50% { box-shadow: 0 0 25px rgba(255, 215, 0, 0.8); }
    }
    .marker-sunny { background: #FFD700; border: 3px solid #fff; }
    .marker-partial { background: #FFA500; border: 2px solid #fff; }
    .marker-shade { background: #4A90D9; border: 2px solid #fff; }
    .marker-no-terrace { background: #1F2937; border: 2px solid #6B7280; }
    .marker-night { background: #6B7280; border: 2px solid #374151; }
    #map { height: 100%; width: 100%; }
    .custom-marker {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }
    .custom-marker:hover { transform: scale(1.5); z-index: 1000 !important; }
    .info-window { padding: 8px; min-width: 200px; }
    /* 3D Map enhancements */
    .gm-style-cc, .gmnoprint { opacity: 0.7; }
    #sunDirectionOverlay { transition: all 0.3s ease; }
    /* Map container with subtle shadow for depth */
    .map-container-3d {
      position: relative;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 
        0 20px 40px rgba(0,0,0,0.15),
        0 0 0 4px #fbbf24,
        inset 0 0 20px rgba(255,200,0,0.1);
    }
    /* User location pulse animation */
    @keyframes userPulse {
      0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }
      70% { box-shadow: 0 0 0 20px rgba(59, 130, 246, 0); }
      100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
    }
    .user-location-marker {
      animation: userPulse 2s infinite;
    }
    /* Distance badge animation */
    @keyframes distancePop {
      0% { transform: scale(0.8); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    .distance-badge {
      animation: distancePop 0.3s ease-out;
    }
    /* Time slider styling */
    #timeSlider {
      -webkit-appearance: none;
      appearance: none;
      height: 12px;
      border-radius: 6px;
      outline: none;
    }
    #timeSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      cursor: pointer;
      border: 3px solid white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      transition: transform 0.2s;
    }
    #timeSlider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }
    #timeSlider::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      cursor: pointer;
      border: 3px solid white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    /* Badge toast animation */
    @keyframes badgeSlideIn {
      0% { transform: translateX(-50%) translateY(100px); opacity: 0; }
      100% { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    #badgeToast:not(.hidden) > div {
      animation: badgeSlideIn 0.5s ease-out, pulse 1s ease-in-out 0.5s 2;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    /* Badge grid styling */
    .badge-card {
      transition: all 0.3s ease;
    }
    .badge-card:hover {
      transform: scale(1.05);
    }
    .badge-unlocked {
      animation: badgeUnlock 0.5s ease-out;
    }
    @keyframes badgeUnlock {
      0% { transform: scale(0) rotate(-180deg); }
      100% { transform: scale(1) rotate(0deg); }
    }
    /* Onboarding animations */
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(100px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes slideOutLeft {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(-100px); }
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .onboarding-slide {
      animation: fadeInUp 0.5s ease-out;
    }
    .onboarding-slide.slide-out {
      animation: slideOutLeft 0.3s ease-in forwards;
    }
    .onboarding-slide.slide-in {
      animation: slideInRight 0.4s ease-out;
    }
    /* Floating animation for emojis */
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    .float-animation {
      animation: float 3s ease-in-out infinite;
    }
    /* Bottom sheet styles */
    #bottomSheet.open {
      transform: translateY(0);
    }
    #bottomSheet.open #bottomSheetBackdrop {
      opacity: 1;
    }
    /* Swipe card styles */
    .swipe-card {
      position: absolute;
      width: 100%;
      height: 100%;
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      transition: transform 0.3s ease, opacity 0.3s ease;
      cursor: grab;
      overflow: hidden;
    }
    .swipe-card:active {
      cursor: grabbing;
    }
    .swipe-card.swiping-left {
      transform: translateX(-120%) rotate(-15deg);
      opacity: 0;
    }
    .swipe-card.swiping-right {
      transform: translateX(120%) rotate(15deg);
      opacity: 0;
    }
    .swipe-card-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 80px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .swipe-card.dragging-left .swipe-card-overlay.left {
      opacity: 0.8;
      background: rgba(239, 68, 68, 0.3);
    }
    .swipe-card.dragging-right .swipe-card-overlay.right {
      opacity: 0.8;
      background: rgba(234, 179, 8, 0.3);
    }
    /* Pull to refresh */
    .pull-indicator {
      transition: transform 0.2s;
    }
    .pulling .pull-indicator {
      transform: rotate(180deg);
    }
    /* Haptic button feedback */
    .haptic-btn:active {
      transform: scale(0.95);
    }
  </style>
</head>
<body class="bg-gradient-to-br from-sky-100 via-amber-50 to-orange-100 min-h-screen">
  
  <!-- Header -->
  <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-lg border-b border-amber-200 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between flex-wrap gap-3">
        <!-- Logo -->
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center shadow-lg shadow-orange-300/50">
            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
            </svg>
          </div>
          <div>
            <h1 class="text-2xl font-black text-amber-600">Spot The Sun</h1>
            <p class="text-xs text-amber-700/70" id="statsHeader">Chargement...</p>
          </div>
        </div>

        <!-- Time Control -->
        <div class="flex items-center gap-2 bg-amber-100 rounded-xl p-1">
          <button onclick="adjustTime(-1)" class="p-2 rounded-lg hover:bg-amber-200 text-amber-700 transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
          </button>
          <div class="flex items-center gap-2 px-3 py-2 text-amber-800">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span class="font-mono font-bold" id="currentTime">--:--</span>
          </div>
          <button onclick="adjustTime(1)" class="p-2 rounded-lg hover:bg-amber-200 text-amber-700 transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
          </button>
          <button onclick="resetTime()" class="px-3 py-2 rounded-lg hover:bg-amber-200 text-amber-700 text-sm font-medium transition">
            Maintenant
          </button>
        </div>

        <!-- Sun Position -->
        <div class="hidden md:flex items-center gap-3 px-4 py-2 rounded-xl bg-gradient-to-r from-yellow-100 to-orange-100 text-amber-800">
          <div class="text-center">
            <div class="text-lg font-bold" id="sunAltitude">--Â°</div>
            <div class="text-xs opacity-70">Altitude</div>
          </div>
          <div class="w-px h-8 bg-amber-400/30"></div>
          <div class="text-center">
            <div class="text-lg font-bold" id="sunAzimuth">--Â°</div>
            <div class="text-xs opacity-70">Azimut</div>
          </div>
        </div>

        <!-- Weather Info -->
        <div id="weatherInfo" class="hidden md:flex items-center gap-2 px-4 py-2 rounded-xl bg-gradient-to-r from-sky-100 to-blue-100 text-blue-800">
          <span class="text-2xl">â³</span>
          <div>
            <div class="font-bold">--Â°C</div>
            <div class="text-xs opacity-70">Chargement...</div>
          </div>
        </div>

        <!-- User Stats -->
        <div class="flex items-center gap-2 px-4 py-2 rounded-xl bg-gradient-to-r from-purple-100 to-pink-100">
          <svg class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
          <div>
            <div class="text-sm font-bold text-purple-800">Niveau <span id="userLevel">1</span></div>
            <div class="text-xs text-purple-600"><span id="userXP">0</span> XP</div>
          </div>
          <div class="ml-2 pl-2 border-l border-purple-300">
            <div class="text-sm font-bold text-orange-600" id="streakDisplay">ğŸ”¥ 0</div>
          </div>
        </div>

        <!-- Geolocation Button -->
        <button onclick="centerOnUser()" class="flex items-center gap-2 px-4 py-2 rounded-xl bg-gradient-to-r from-blue-500 to-cyan-500 text-white font-medium shadow-lg shadow-blue-300/50 hover:shadow-xl hover:scale-105 transition-all">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
          <span>Ma position</span>
        </button>

        <!-- Badges Button -->
        <button onclick="showBadgesModal()" class="flex items-center gap-2 px-4 py-2 rounded-xl bg-gradient-to-r from-amber-500 to-yellow-500 text-white font-medium shadow-lg shadow-amber-300/50 hover:shadow-xl hover:scale-105 transition-all">
          <span class="text-lg">ğŸ†</span>
          <span id="badgeCount">0</span>
        </button>
        
        <!-- Leaderboard Button -->
        <button onclick="showLeaderboardModal()" class="flex items-center gap-2 px-3 py-2 rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 text-white font-medium shadow-lg shadow-purple-300/50 hover:shadow-xl hover:scale-105 transition-all">
          <span class="text-lg">ğŸ‘‘</span>
        </button>

        <!-- Install PWA Button (hidden by default) -->
        <button id="installBtn" onclick="installPWA()" class="hidden items-center gap-2 px-4 py-2 rounded-xl bg-gradient-to-r from-green-500 to-emerald-500 text-white font-medium shadow-lg shadow-green-300/50 hover:shadow-xl hover:scale-105 transition-all animate-pulse">
          <span class="text-lg">ğŸ“²</span>
          <span>Installer</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 py-6">
    
    <!-- Stats Cards -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
      <button onclick="setFilter('sunny')" id="filterSunny" class="p-4 rounded-xl bg-yellow-100 border-2 border-transparent hover:border-yellow-500 transition-all">
        <div class="flex items-center justify-between">
          <span class="text-2xl">â˜€ï¸</span>
          <span class="text-2xl font-bold text-yellow-700" id="countSunny">--</span>
        </div>
        <p class="text-sm mt-1 text-yellow-600">Au soleil</p>
      </button>

      <button onclick="setFilter('shade')" id="filterShade" class="p-4 rounded-xl bg-blue-100 border-2 border-transparent hover:border-blue-500 transition-all">
        <div class="flex items-center justify-between">
          <span class="text-2xl">ğŸŒ¥ï¸</span>
          <span class="text-2xl font-bold text-blue-700" id="countShade">--</span>
        </div>
        <p class="text-sm mt-1 text-blue-600">Ã€ l'ombre</p>
      </button>

      <button onclick="setFilter('noTerrace')" id="filterNoTerrace" class="p-4 rounded-xl bg-gray-100 border-2 border-transparent hover:border-gray-500 transition-all">
        <div class="flex items-center justify-between">
          <span class="text-2xl">ğŸ </span>
          <span class="text-2xl font-bold text-gray-700" id="countNoTerrace">--</span>
        </div>
        <p class="text-sm mt-1 text-gray-600">Sans terrasse</p>
      </button>

      <button onclick="setFilter('terrace')" id="filterTerrace" class="p-4 rounded-xl bg-green-100 border-2 border-transparent hover:border-green-500 transition-all">
        <div class="flex items-center justify-between">
          <span class="text-2xl">ğŸª‘</span>
          <span class="text-2xl font-bold text-green-700" id="countTerrace">--</span>
        </div>
        <p class="text-sm mt-1 text-green-600">Avec terrasse</p>
      </button>

      <button onclick="setFilter('all')" id="filterAll" class="p-4 rounded-xl bg-purple-100 border-2 border-purple-500 transition-all">
        <div class="flex items-center justify-between">
          <span class="text-2xl">ğŸ“</span>
          <span class="text-2xl font-bold text-purple-700" id="countTotal">--</span>
        </div>
        <p class="text-sm mt-1 text-purple-600">Tous les bars</p>
      </button>
    </div>

    <!-- Geo Status & Sort Controls -->
    <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
      <div id="geoStatus" class="text-sm text-gray-500">ğŸ“ Position non activÃ©e</div>
      <div class="flex items-center gap-2">
        <span class="text-sm text-gray-600">Trier par:</span>
        <select id="sortSelect" onchange="handleSort()" class="px-3 py-2 rounded-lg border border-amber-200 bg-white text-sm focus:border-amber-400 outline-none">
          <option value="sun">â˜€ï¸ Ensoleillement</option>
          <option value="distance">ğŸ“ Distance</option>
          <option value="rating">â­ Note</option>
          <option value="reviews">ğŸ’¬ PopularitÃ©</option>
        </select>
      </div>
    </div>

    <!-- Search -->
    <div class="mb-6 relative">
      <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
      <input type="text" id="searchInput" placeholder="Rechercher un bar..." class="w-full pl-12 pr-4 py-3 rounded-xl border-2 border-amber-200 bg-white focus:border-amber-400 outline-none transition" oninput="handleSearch()">
    </div>

    <!-- Time Slider -->
    <div class="mb-6 p-4 bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl border border-amber-200">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-bold text-amber-800">â° Simulation horaire</h3>
        <div class="flex items-center gap-2">
          <button onclick="playTimelapse()" id="playBtn" class="px-3 py-1 rounded-lg bg-amber-500 hover:bg-amber-600 text-white text-sm font-medium transition">
            â–¶ï¸ Animer
          </button>
          <button onclick="resetTime()" class="px-3 py-1 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-medium transition">
            ğŸ”„ Maintenant
          </button>
        </div>
      </div>
      
      <div class="relative">
        <input type="range" id="timeSlider" min="0" max="1440" value="720" 
          class="w-full h-3 rounded-full appearance-none cursor-pointer"
          style="background: linear-gradient(to right, #1e3a5f 0%, #f59e0b 25%, #fbbf24 50%, #f59e0b 75%, #1e3a5f 100%);"
          oninput="handleTimeSlider(this.value)">
        
        <!-- Time markers -->
        <div class="flex justify-between mt-2 text-xs text-amber-700">
          <span>00:00</span>
          <span>06:00</span>
          <span>12:00</span>
          <span>18:00</span>
          <span>23:59</span>
        </div>
      </div>
      
      <!-- Sun path visualization -->
      <div class="mt-4 relative h-16 bg-gradient-to-b from-sky-200 to-sky-100 rounded-xl overflow-hidden">
        <div class="absolute inset-x-0 bottom-0 h-4 bg-gradient-to-t from-green-600 to-green-500"></div>
        <div id="sunPathIndicator" class="absolute w-8 h-8 rounded-full bg-yellow-400 shadow-lg shadow-yellow-400/50 flex items-center justify-center text-lg transition-all duration-300" style="left: 50%; top: 20%;">
          â˜€ï¸
        </div>
        <!-- Horizon line -->
        <div class="absolute inset-x-0 bottom-4 h-px bg-amber-600/30"></div>
      </div>
      
      <!-- Prediction panel -->
      <div id="predictionPanel" class="mt-4 grid grid-cols-4 gap-2">
        <!-- Will be filled dynamically -->
      </div>
    </div>

    <!-- Map Container -->
    <div class="map-container-3d mb-6" style="height: 600px;">
      <div id="map"></div>
    </div>

    <!-- Legend -->
    <div class="flex flex-wrap justify-center gap-6 mb-6 p-4 bg-white/80 rounded-xl">
      <div class="flex items-center gap-2">
        <div class="w-5 h-5 rounded-full bg-yellow-400 border-2 border-white shadow pulse-glow"></div>
        <span class="text-sm text-gray-700">Terrasse au soleil</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-5 h-5 rounded-full bg-orange-400 border-2 border-white shadow"></div>
        <span class="text-sm text-gray-700">Partiellement ensoleillÃ©</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-5 h-5 rounded-full bg-blue-400 border-2 border-white shadow"></div>
        <span class="text-sm text-gray-700">Terrasse Ã  l'ombre</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-5 h-5 rounded-full bg-gray-800 border-2 border-gray-500 shadow"></div>
        <span class="text-sm text-gray-700">Sans terrasse</span>
      </div>
    </div>
    
    <!-- 3D Controls Help -->
    <div class="mb-6 p-4 bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl border border-amber-200">
      <h3 class="font-bold text-amber-800 mb-2">ğŸ™ï¸ ContrÃ´les 3D</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm text-amber-700">
        <div class="flex items-center gap-2">
          <span class="font-mono bg-amber-100 px-2 py-1 rounded">Ctrl + Glisser</span>
          <span>Rotation 3D</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="font-mono bg-amber-100 px-2 py-1 rounded">Molette</span>
          <span>Zoom</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="font-mono bg-amber-100 px-2 py-1 rounded">â˜€ï¸ Aligner</span>
          <span>Vue direction soleil</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="font-mono bg-amber-100 px-2 py-1 rounded">ğŸ™ï¸ 2D/3D</span>
          <span>Basculer perspective</span>
        </div>
      </div>
      <p class="text-xs text-amber-600 mt-2 italic">â˜ï¸ MÃ©tÃ©o temps rÃ©el prise en compte â€¢ Le dÃ©gradÃ© sur la carte simule la direction de la lumiÃ¨re solaire</p>
    </div>

    <!-- Bar List -->
    <h2 class="text-xl font-bold text-amber-800 mb-4">ğŸ”¥ Top terrasses ensoleillÃ©es</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="barList">
      <!-- Bars will be inserted here -->
    </div>
  </div>

  <!-- Bar Detail Modal -->
  <div id="barModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
    <div class="max-w-md w-full bg-white rounded-2xl shadow-2xl" id="modalContent">
      <!-- Modal content inserted by JS -->
    </div>
  </div>

  <!-- Badges Modal -->
  <div id="badgesModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
    <div class="max-w-2xl w-full max-h-[90vh] bg-white rounded-2xl shadow-2xl overflow-hidden">
      <div class="p-6 bg-gradient-to-r from-amber-400 to-yellow-500 text-white">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-2xl font-bold flex items-center gap-2">ğŸ† Mes Badges</h2>
            <p class="text-amber-100 mt-1">Collectionne-les tous !</p>
          </div>
          <button onclick="closeBadgesModal()" class="p-2 rounded-lg bg-white/20 hover:bg-white/30 transition">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
          </button>
        </div>
        
        <!-- Stats summary -->
        <div class="grid grid-cols-4 gap-3 mt-4">
          <div class="bg-white/20 rounded-xl p-3 text-center">
            <div class="text-2xl font-bold" id="badgesUnlocked">0</div>
            <div class="text-xs text-amber-100">DÃ©bloquÃ©s</div>
          </div>
          <div class="bg-white/20 rounded-xl p-3 text-center">
            <div class="text-2xl font-bold" id="totalCheckins">0</div>
            <div class="text-xs text-amber-100">Check-ins</div>
          </div>
          <div class="bg-white/20 rounded-xl p-3 text-center">
            <div class="text-2xl font-bold" id="currentStreak">0</div>
            <div class="text-xs text-amber-100">ğŸ”¥ Streak</div>
          </div>
          <div class="bg-white/20 rounded-xl p-3 text-center">
            <div class="text-2xl font-bold" id="arrondsVisited">0</div>
            <div class="text-xs text-amber-100">ğŸ“ Arronds.</div>
          </div>
        </div>
      </div>
      
      <div class="p-6 overflow-y-auto max-h-[50vh]" id="badgesGrid">
        <!-- Badges grid inserted by JS -->
      </div>
    </div>
  </div>

  <!-- Badge Unlocked Toast -->
  <div id="badgeToast" class="fixed bottom-24 left-1/2 -translate-x-1/2 z-[100] hidden">
    <div class="bg-gradient-to-r from-amber-400 to-yellow-500 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-4 animate-bounce">
      <div class="text-4xl" id="toastIcon">ğŸ†</div>
      <div>
        <p class="font-bold text-lg" id="toastTitle">Badge dÃ©bloquÃ© !</p>
        <p class="text-amber-100" id="toastDesc">Description</p>
      </div>
    </div>
  </div>

  <!-- PWA Install Banner (Mobile) -->
  <div id="installBanner" class="fixed bottom-0 left-0 right-0 z-[90] hidden">
    <div class="bg-gradient-to-r from-amber-500 via-orange-500 to-yellow-500 p-4 shadow-2xl">
      <div class="max-w-4xl mx-auto flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center text-2xl">â˜€ï¸</div>
          <div class="text-white">
            <p class="font-bold">Installer Spot The Sun</p>
            <p class="text-sm text-amber-100">AccÃ¨s rapide depuis l'Ã©cran d'accueil</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="dismissInstallBanner()" class="px-3 py-2 text-amber-200 hover:text-white transition">
            Plus tard
          </button>
          <button onclick="installPWA()" class="px-4 py-2 bg-white text-orange-600 font-bold rounded-xl hover:bg-amber-50 transition shadow-lg">
            Installer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Bottom Sheet -->
  <div id="bottomSheet" class="fixed inset-x-0 bottom-0 z-[80] transform translate-y-full transition-transform duration-300 ease-out md:hidden">
    <!-- Backdrop -->
    <div id="bottomSheetBackdrop" class="fixed inset-0 bg-black/40 opacity-0 transition-opacity duration-300 -z-10" onclick="closeBottomSheet()"></div>
    
    <!-- Sheet Content -->
    <div class="bg-white rounded-t-3xl shadow-2xl max-h-[85vh] flex flex-col">
      <!-- Handle -->
      <div class="flex justify-center py-3 cursor-grab" id="sheetHandle">
        <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
      </div>
      
      <!-- Header -->
      <div class="px-4 pb-3 border-b border-gray-100">
        <div class="flex items-center justify-between">
          <h3 class="font-bold text-lg text-gray-800" id="bottomSheetTitle">Bars Ã  proximitÃ©</h3>
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-500" id="bottomSheetCount">0 rÃ©sultats</span>
            <button onclick="closeBottomSheet()" class="p-2 hover:bg-gray-100 rounded-full">
              <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
          </div>
        </div>
        
        <!-- Quick filters -->
        <div class="flex gap-2 mt-3 overflow-x-auto pb-2 -mx-4 px-4">
          <button onclick="setFilter('sunny'); updateBottomSheet()" class="flex-shrink-0 px-4 py-2 rounded-full bg-yellow-100 text-yellow-700 text-sm font-medium whitespace-nowrap">â˜€ï¸ Au soleil</button>
          <button onclick="setFilter('all'); updateBottomSheet()" class="flex-shrink-0 px-4 py-2 rounded-full bg-gray-100 text-gray-700 text-sm font-medium whitespace-nowrap">ğŸ“ Tout</button>
          <button onclick="document.getElementById('sortSelect').value='distance'; handleSort(); updateBottomSheet()" class="flex-shrink-0 px-4 py-2 rounded-full bg-blue-100 text-blue-700 text-sm font-medium whitespace-nowrap">ğŸ“ Distance</button>
        </div>
      </div>
      
      <!-- Pull to refresh indicator -->
      <div id="pullToRefreshIndicator" class="hidden items-center justify-center py-4 text-amber-600">
        <svg class="w-6 h-6 animate-spin mr-2" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
        </svg>
        <span class="text-sm font-medium">Actualisation...</span>
      </div>
      
      <!-- Swipe Cards Container -->
      <div id="swipeCardsContainer" class="flex-1 overflow-hidden relative px-4 py-4 hidden">
        <div id="swipeCards" class="relative h-[300px]">
          <!-- Cards will be inserted here -->
        </div>
        <div class="flex justify-center gap-8 mt-4">
          <button onclick="swipeCard('left')" class="w-16 h-16 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-2xl shadow-lg transition-transform active:scale-90">
            ğŸ‘
          </button>
          <button onclick="swipeCard('right')" class="w-16 h-16 rounded-full bg-yellow-400 hover:bg-yellow-500 flex items-center justify-center text-2xl shadow-lg transition-transform active:scale-90">
            â˜€ï¸
          </button>
        </div>
        <p class="text-center text-gray-400 text-sm mt-3">â† Passer Â· Voir le bar â†’</p>
      </div>
      
      <!-- List View (default) -->
      <div id="bottomSheetList" class="flex-1 overflow-y-auto px-4 py-2" style="max-height: 50vh;">
        <!-- Bars list will be inserted here -->
      </div>
      
      <!-- View Toggle -->
      <div class="px-4 py-3 border-t border-gray-100 flex justify-center gap-2">
        <button onclick="toggleBottomSheetView('list')" id="viewListBtn" class="px-4 py-2 rounded-lg bg-amber-500 text-white text-sm font-medium">ğŸ“‹ Liste</button>
        <button onclick="toggleBottomSheetView('swipe')" id="viewSwipeBtn" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-700 text-sm font-medium">ğŸ’« Swipe</button>
      </div>
    </div>
  </div>

  <!-- Mobile FAB to open bottom sheet -->
  <button id="mobileListFab" onclick="openBottomSheet()" class="fixed bottom-6 right-6 z-[70] w-14 h-14 rounded-full bg-gradient-to-r from-amber-500 to-orange-500 text-white shadow-lg shadow-amber-500/40 flex items-center justify-center text-2xl md:hidden hover:scale-110 transition-transform active:scale-95">
    ğŸ“‹
  </button>
  
  <!-- Map Controls Panel -->
  <div id="mapControlsPanel" class="fixed top-24 left-4 z-[60] flex flex-col gap-2">
    <button id="clusterToggle" onclick="toggleClusters()" class="w-12 h-12 rounded-xl bg-amber-500 text-white shadow-lg flex items-center justify-center text-xl hover:scale-105 transition-transform active:scale-95" title="Regrouper les marqueurs">
      ğŸ”˜
    </button>
    <button id="heatmapToggle" onclick="toggleHeatmap()" class="w-12 h-12 rounded-xl bg-white text-gray-700 shadow-lg flex items-center justify-center text-xl hover:scale-105 transition-transform active:scale-95" title="Afficher la heatmap soleil">
      ğŸ”¥
    </button>
    <button onclick="clearRoute()" id="clearRouteBtn" class="w-12 h-12 rounded-xl bg-white text-gray-700 shadow-lg flex items-center justify-center text-xl hover:scale-105 transition-transform active:scale-95 hidden" title="Effacer l'itinÃ©raire">
      ğŸš«
    </button>
    <button onclick="showChallengesModal()" class="w-12 h-12 rounded-xl bg-white text-gray-700 shadow-lg flex items-center justify-center text-xl hover:scale-105 transition-transform active:scale-95" title="DÃ©fis du jour">
      ğŸ¯
    </button>
  </div>
  
  <!-- Daily Challenges Floating Panel -->
  <div id="challengesPanel" class="fixed top-24 right-4 z-[60] w-72 bg-white rounded-2xl shadow-xl hidden md:block overflow-hidden">
    <div class="bg-gradient-to-r from-purple-500 to-pink-500 p-3">
      <div class="flex items-center justify-between">
        <h3 class="font-bold text-white flex items-center gap-2">
          <span>ğŸ¯</span> DÃ©fis du jour
        </h3>
        <button onclick="toggleChallengesPanel()" class="text-white/80 hover:text-white">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>
      <p class="text-purple-100 text-xs mt-1" id="challengesTimer">Renouvellement dans 12h</p>
    </div>
    <div id="challengesList" class="p-3 space-y-2 max-h-64 overflow-y-auto">
      <!-- Challenges will be inserted here -->
    </div>
    <div class="p-3 border-t border-gray-100 bg-gray-50">
      <div class="flex items-center justify-between text-sm">
        <span class="text-gray-600">XP gagnÃ©s aujourd'hui</span>
        <span class="font-bold text-purple-600" id="dailyXpCount">+0 XP</span>
      </div>
    </div>
  </div>
  
  <!-- Challenges Modal (Mobile + Full view) -->
  <div id="challengesModal" class="fixed inset-0 bg-black/50 z-[150] hidden items-center justify-center p-4">
    <div class="bg-white rounded-3xl w-full max-w-lg max-h-[85vh] overflow-hidden shadow-2xl">
      <div class="bg-gradient-to-r from-purple-500 via-pink-500 to-orange-500 p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-black text-white">ğŸ¯ DÃ©fis du jour</h2>
          <button onclick="closeChallengesModal()" class="p-2 hover:bg-white/20 rounded-full transition">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
          </button>
        </div>
        <div class="flex items-center gap-4">
          <div class="bg-white/20 backdrop-blur rounded-xl p-3 text-center">
            <p class="text-3xl font-black text-white" id="modalCompletedCount">0/3</p>
            <p class="text-xs text-purple-100">ComplÃ©tÃ©s</p>
          </div>
          <div class="bg-white/20 backdrop-blur rounded-xl p-3 text-center flex-1">
            <p class="text-2xl font-black text-white" id="modalDailyXp">+0 XP</p>
            <p class="text-xs text-purple-100">GagnÃ©s aujourd'hui</p>
          </div>
          <div class="bg-white/20 backdrop-blur rounded-xl p-3 text-center">
            <p class="text-lg font-bold text-white" id="modalTimer">12h</p>
            <p class="text-xs text-purple-100">Restant</p>
          </div>
        </div>
      </div>
      
      <div class="p-4 space-y-3 overflow-y-auto" style="max-height: 50vh;" id="modalChallengesList">
        <!-- Challenges will be inserted here -->
      </div>
      
      <!-- Streak bonus section -->
      <div class="p-4 border-t border-gray-100 bg-gradient-to-r from-orange-50 to-yellow-50">
        <div class="flex items-center gap-3">
          <div class="text-4xl">ğŸ”¥</div>
          <div class="flex-1">
            <p class="font-bold text-gray-800">Bonus Streak x<span id="streakMultiplier">1</span></p>
            <p class="text-sm text-gray-500">Chaque jour de streak = +10% XP</p>
          </div>
          <div class="text-right">
            <p class="text-2xl font-black text-orange-500" id="currentStreakDisplay">0</p>
            <p class="text-xs text-gray-500">jours</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Leaderboard Modal -->
  <div id="leaderboardModal" class="fixed inset-0 bg-black/50 z-[150] hidden items-center justify-center p-4">
    <div class="bg-white rounded-3xl w-full max-w-lg max-h-[85vh] overflow-hidden shadow-2xl">
      <div class="bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 p-6">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-2xl font-black text-white">ğŸ† Classement</h2>
          <button onclick="closeLeaderboardModal()" class="p-2 hover:bg-white/20 rounded-full transition">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
          </button>
        </div>
        <p class="text-yellow-100 text-sm">Compare-toi avec tes amis !</p>
      </div>
      
      <!-- Tab navigation -->
      <div class="flex border-b border-gray-200">
        <button onclick="showLeaderboardTab('weekly')" id="tabWeekly" class="flex-1 py-3 font-medium text-amber-600 border-b-2 border-amber-500">Cette semaine</button>
        <button onclick="showLeaderboardTab('alltime')" id="tabAlltime" class="flex-1 py-3 font-medium text-gray-400 hover:text-gray-600">Tout temps</button>
      </div>
      
      <!-- Your rank -->
      <div class="p-4 bg-gradient-to-r from-amber-50 to-yellow-50 border-b border-amber-100">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-white font-black text-xl" id="yourRank">?</div>
          <div class="flex-1">
            <p class="font-bold text-gray-800">Toi</p>
            <p class="text-sm text-gray-500"><span id="yourXp">0</span> XP cette semaine</p>
          </div>
          <div class="text-right">
            <p class="text-sm text-gray-500">Niveau</p>
            <p class="text-xl font-black text-amber-600" id="yourLevel">1</p>
          </div>
        </div>
      </div>
      
      <!-- Leaderboard list -->
      <div class="p-4 space-y-2 overflow-y-auto" style="max-height: 40vh;" id="leaderboardList">
        <!-- Fake leaderboard for demo -->
      </div>
      
      <!-- Invite friends -->
      <div class="p-4 border-t border-gray-100">
        <button onclick="shareWithFriends()" class="w-full py-3 rounded-xl font-bold text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 transition flex items-center justify-center gap-2">
          <span>ğŸ‘¥</span> Inviter des amis
        </button>
        <p class="text-center text-xs text-gray-400 mt-2">Gagne le badge ğŸ¤ Parrain en invitant 3 amis !</p>
      </div>
    </div>
  </div>
  
  <!-- Challenge Complete Toast -->
  <div id="challengeToast" class="fixed top-24 left-1/2 -translate-x-1/2 z-[200] hidden">
    <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-4 animate-bounce">
      <div class="text-4xl" id="challengeToastIcon">ğŸ¯</div>
      <div>
        <p class="font-bold" id="challengeToastTitle">DÃ©fi complÃ©tÃ© !</p>
        <p class="text-sm text-purple-100" id="challengeToastXp">+50 XP</p>
      </div>
    </div>
  </div>

  <!-- Offline indicator -->
  <div id="offlineIndicator" class="fixed top-20 left-1/2 -translate-x-1/2 z-[100] hidden">
    <div class="bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg flex items-center gap-2">
      <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
      <span class="text-sm font-medium">Mode hors-ligne</span>
    </div>
  </div>

  <!-- Onboarding Modal -->
  <div id="onboardingModal" class="fixed inset-0 bg-gradient-to-br from-amber-400 via-orange-500 to-yellow-500 z-[200] hidden items-center justify-center">
    <div class="max-w-md w-full mx-4">
      <!-- Slides Container -->
      <div id="onboardingSlides" class="relative overflow-hidden">
        
        <!-- Slide 1: Welcome -->
        <div class="onboarding-slide" data-slide="0">
          <div class="text-center p-8">
            <div class="text-8xl mb-6">â˜€ï¸</div>
            <h1 class="text-3xl font-black text-white mb-4">Bienvenue sur<br>Spot The Sun !</h1>
            <p class="text-amber-100 text-lg mb-8">Trouve les terrasses ensoleillÃ©es Ã  Paris en temps rÃ©el</p>
            <div class="bg-white/20 backdrop-blur rounded-2xl p-6 text-left">
              <div class="flex items-center gap-4 mb-4">
                <div class="w-12 h-12 rounded-full bg-yellow-400 flex items-center justify-center text-2xl">ğŸ—ºï¸</div>
                <div class="text-white">
                  <p class="font-bold">3 721 bars</p>
                  <p class="text-amber-100 text-sm">rÃ©fÃ©rencÃ©s Ã  Paris</p>
                </div>
              </div>
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-yellow-400 flex items-center justify-center text-2xl">ğŸº</div>
                <div class="text-white">
                  <p class="font-bold">1 934 terrasses</p>
                  <p class="text-amber-100 text-sm">analysÃ©es en temps rÃ©el</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Slide 2: Features -->
        <div class="onboarding-slide hidden" data-slide="1">
          <div class="text-center p-8">
            <div class="text-7xl mb-6">ğŸ¯</div>
            <h2 class="text-2xl font-black text-white mb-4">Comment Ã§a marche ?</h2>
            <div class="space-y-4 text-left">
              <div class="bg-white/20 backdrop-blur rounded-xl p-4 flex items-center gap-4">
                <div class="w-10 h-10 rounded-full bg-yellow-400 flex items-center justify-center font-bold text-orange-800">1</div>
                <div class="text-white">
                  <p class="font-bold">Regarde la carte</p>
                  <p class="text-amber-100 text-sm">Les points jaunes = terrasses au soleil â˜€ï¸</p>
                </div>
              </div>
              <div class="bg-white/20 backdrop-blur rounded-xl p-4 flex items-center gap-4">
                <div class="w-10 h-10 rounded-full bg-yellow-400 flex items-center justify-center font-bold text-orange-800">2</div>
                <div class="text-white">
                  <p class="font-bold">Simule une heure</p>
                  <p class="text-amber-100 text-sm">Utilise le slider pour prÃ©voir ta sortie</p>
                </div>
              </div>
              <div class="bg-white/20 backdrop-blur rounded-xl p-4 flex items-center gap-4">
                <div class="w-10 h-10 rounded-full bg-yellow-400 flex items-center justify-center font-bold text-orange-800">3</div>
                <div class="text-white">
                  <p class="font-bold">Fais un check-in</p>
                  <p class="text-amber-100 text-sm">Gagne des XP et dÃ©bloque des badges ğŸ†</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Slide 3: Badges -->
        <div class="onboarding-slide hidden" data-slide="2">
          <div class="text-center p-8">
            <div class="text-7xl mb-6">ğŸ†</div>
            <h2 class="text-2xl font-black text-white mb-4">Collectionne les badges !</h2>
            <p class="text-amber-100 mb-6">22 badges Ã  dÃ©bloquer en explorant Paris</p>
            <div class="grid grid-cols-4 gap-3 mb-6">
              <div class="bg-white/20 backdrop-blur rounded-xl p-3 text-center">
                <div class="text-3xl mb-1">â˜€ï¸</div>
                <p class="text-xs text-white">Soleil</p>
              </div>
              <div class="bg-white/20 backdrop-blur rounded-xl p-3 text-center">
                <div class="text-3xl mb-1">ğŸ¦</div>
                <p class="text-xs text-white">LÃ¨ve-tÃ´t</p>
              </div>
              <div class="bg-white/20 backdrop-blur rounded-xl p-3 text-center">
                <div class="text-3xl mb-1">ğŸ—ºï¸</div>
                <p class="text-xs text-white">Explorateur</p>
              </div>
              <div class="bg-white/20 backdrop-blur rounded-xl p-3 text-center">
                <div class="text-3xl mb-1">ğŸ”¥</div>
                <p class="text-xs text-white">Streak</p>
              </div>
            </div>
            <div class="bg-white/20 backdrop-blur rounded-xl p-4">
              <p class="text-white font-medium">ğŸ’¡ Astuce</p>
              <p class="text-amber-100 text-sm">Installe l'app sur ton Ã©cran d'accueil pour y accÃ©der plus vite !</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Navigation -->
      <div class="px-8 pb-8">
        <!-- Progress dots -->
        <div class="flex justify-center gap-2 mb-6">
          <div class="onboarding-dot w-2 h-2 rounded-full bg-white transition-all" data-dot="0"></div>
          <div class="onboarding-dot w-2 h-2 rounded-full bg-white/40 transition-all" data-dot="1"></div>
          <div class="onboarding-dot w-2 h-2 rounded-full bg-white/40 transition-all" data-dot="2"></div>
        </div>
        
        <!-- Buttons -->
        <div class="flex gap-3">
          <button id="onboardingSkip" onclick="skipOnboarding()" class="flex-1 py-4 rounded-xl font-bold text-white/80 hover:text-white transition">
            Passer
          </button>
          <button id="onboardingNext" onclick="nextOnboardingSlide()" class="flex-1 py-4 rounded-xl font-bold bg-white text-orange-600 hover:bg-amber-50 transition shadow-lg">
            Suivant â†’
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- JAVASCRIPT -->
  <!-- ============================================ -->
  <script>
    // ==========================================
    // ğŸ”‘ REMPLACE CETTE CLÃ‰ PAR LA TIENNE
    // ==========================================
    const GOOGLE_MAPS_API_KEY = 'AIzaSyAFF0Qk3gQkkyBt3mcPnfmwl7hDHXmVtBo';
    
    // ==========================================
    // BARS DATA - Loaded from JSON file
    // ==========================================
    let BARS_DATA = [];
    let dataLoaded = false;

    async function loadBarsData() {
      try {
        document.getElementById('statsHeader').textContent = 'Chargement des 3721 bars...';
        const response = await fetch('bars_paris.json');
        if (response.ok) {
          BARS_DATA = await response.json();
          dataLoaded = true;
          console.log(`âœ… ${BARS_DATA.length} bars chargÃ©s !`);
          createMarkers();
          updateUI();
        } else {
          console.error('Erreur chargement JSON:', response.status);
          document.getElementById('statsHeader').textContent = 'Erreur de chargement des donnÃ©es';
        }
      } catch (error) {
        console.error('Erreur:', error);
        document.getElementById('statsHeader').textContent = 'Erreur: ' + error.message;
      }
    }

    // ==========================================
    // STATE
    // ==========================================
    let map;
    let markers = [];
    let currentFilter = 'all';
    let currentTime = new Date();
    let userStats = { 
      xp: 0, 
      level: 1, 
      checkins: new Set(),
      sunnyCheckins: 0,
      shadeCheckins: 0,
      earlyCheckins: 0,
      lateCheckins: 0,
      streak: 0,
      lastCheckinDate: null,
      badges: new Set(),
      arrondissements: new Set()
    };
    let weatherData = null;
    let userLocation = null;
    let userMarker = null;
    let watchPositionId = null;
    
    // Map enhancements
    let markerClusterer = null;
    let heatmapLayer = null;
    let directionsService = null;
    let directionsRenderer = null;
    let showHeatmap = false;
    let showClusters = true;
    
    // Daily challenges system
    let dailyChallenges = [];
    const CHALLENGE_TYPES = [
      { id: 'sunny_3', name: 'Chasseur de soleil', desc: 'Visite 3 bars au soleil', icon: 'â˜€ï¸', target: 3, type: 'sunny' },
      { id: 'sunny_5', name: 'Expert solaire', desc: 'Visite 5 bars au soleil', icon: 'ğŸŒŸ', target: 5, type: 'sunny' },
      { id: 'bars_5', name: 'Explorateur', desc: 'Visite 5 bars diffÃ©rents', icon: 'ğŸ—ºï¸', target: 5, type: 'total' },
      { id: 'bars_10', name: 'Grand explorateur', desc: 'Visite 10 bars diffÃ©rents', icon: 'ğŸ†', target: 10, type: 'total' },
      { id: 'arrond_3', name: 'Voyageur', desc: 'Visite 3 arrondissements', icon: 'ğŸ§­', target: 3, type: 'arrondissements' },
      { id: 'early_bird', name: 'LÃ¨ve-tÃ´t', desc: 'Check-in avant 11h', icon: 'ğŸ¦', target: 1, type: 'early' },
      { id: 'golden_hour', name: 'Golden Hour', desc: 'Check-in entre 17h et 19h', icon: 'ğŸŒ‡', target: 1, type: 'golden' },
      { id: 'streak_keep', name: 'RÃ©gulier', desc: 'Maintiens ton streak', icon: 'ğŸ”¥', target: 1, type: 'streak' },
      { id: 'distance_1km', name: 'Marcheur', desc: 'Marche 1km entre 2 bars', icon: 'ğŸš¶', target: 1000, type: 'distance' },
    ];
    
    // Daily progress tracking
    let dailyProgress = {
      date: null,
      sunnyVisits: 0,
      totalVisits: 0,
      arrondissementsToday: new Set(),
      earlyVisit: false,
      goldenVisit: false,
      streakKept: false,
      distanceWalked: 0,
      lastBarLocation: null,
      completedChallenges: new Set(),
      xpEarned: 0
    };

    // ==========================================
    // BADGES DEFINITIONS
    // ==========================================
    const BADGES = {
      // Sun chaser badges
      sun_starter: { id: 'sun_starter', name: 'Premier Rayon', icon: 'ğŸŒ…', desc: 'Premier check-in au soleil', condition: s => s.sunnyCheckins >= 1 },
      sun_lover: { id: 'sun_lover', name: 'Adorateur du Soleil', icon: 'â˜€ï¸', desc: '10 check-ins au soleil', condition: s => s.sunnyCheckins >= 10 },
      sun_master: { id: 'sun_master', name: 'MaÃ®tre du Soleil', icon: 'ğŸŒŸ', desc: '50 check-ins au soleil', condition: s => s.sunnyCheckins >= 50 },
      sun_legend: { id: 'sun_legend', name: 'LÃ©gende Solaire', icon: 'ğŸ‘‘', desc: '100 check-ins au soleil', condition: s => s.sunnyCheckins >= 100 },
      
      // Time-based badges
      early_bird: { id: 'early_bird', name: 'LÃ¨ve-TÃ´t', icon: 'ğŸ¦', desc: 'Check-in avant 10h', condition: s => s.earlyCheckins >= 1 },
      night_owl: { id: 'night_owl', name: 'Oiseau de Nuit', icon: 'ğŸ¦‰', desc: 'Check-in aprÃ¨s 20h', condition: s => s.lateCheckins >= 1 },
      golden_hour: { id: 'golden_hour', name: 'Golden Hour', icon: 'ğŸŒ‡', desc: 'Check-in entre 17h et 19h', condition: s => s.goldenHourCheckins >= 1 },
      
      // Explorer badges
      explorer_5: { id: 'explorer_5', name: 'Explorateur', icon: 'ğŸ§­', desc: '5 arrondissements visitÃ©s', condition: s => s.arrondissements.size >= 5 },
      explorer_10: { id: 'explorer_10', name: 'Grand Explorateur', icon: 'ğŸ—ºï¸', desc: '10 arrondissements visitÃ©s', condition: s => s.arrondissements.size >= 10 },
      explorer_20: { id: 'explorer_20', name: 'Roi de Paris', icon: 'ğŸ°', desc: 'Tous les arrondissements !', condition: s => s.arrondissements.size >= 20 },
      
      // Streak badges
      streak_3: { id: 'streak_3', name: 'HabituÃ©', icon: 'ğŸ”¥', desc: '3 jours consÃ©cutifs', condition: s => s.maxStreak >= 3 },
      streak_7: { id: 'streak_7', name: 'RÃ©gulier', icon: 'ğŸ’ª', desc: '7 jours consÃ©cutifs', condition: s => s.maxStreak >= 7 },
      streak_30: { id: 'streak_30', name: 'Inconditionnel', icon: 'âš¡', desc: '30 jours consÃ©cutifs', condition: s => s.maxStreak >= 30 },
      
      // Volume badges
      first_checkin: { id: 'first_checkin', name: 'PremiÃ¨re Fois', icon: 'ğŸ‰', desc: 'Premier check-in !', condition: s => s.checkins.size >= 1 },
      regular_10: { id: 'regular_10', name: 'HabituÃ©', icon: 'ğŸº', desc: '10 bars visitÃ©s', condition: s => s.checkins.size >= 10 },
      regular_50: { id: 'regular_50', name: 'Connaisseur', icon: 'ğŸ¥‚', desc: '50 bars visitÃ©s', condition: s => s.checkins.size >= 50 },
      regular_100: { id: 'regular_100', name: 'Expert', icon: 'ğŸ†', desc: '100 bars visitÃ©s', condition: s => s.checkins.size >= 100 },
      
      // Level badges
      level_5: { id: 'level_5', name: 'Niveau 5', icon: 'â­', desc: 'Atteindre le niveau 5', condition: s => s.level >= 5 },
      level_10: { id: 'level_10', name: 'Niveau 10', icon: 'ğŸŒŸ', desc: 'Atteindre le niveau 10', condition: s => s.level >= 10 },
      level_20: { id: 'level_20', name: 'Niveau 20', icon: 'ğŸ’«', desc: 'Atteindre le niveau 20', condition: s => s.level >= 20 },
      
      // Special badges
      shade_lover: { id: 'shade_lover', name: 'Ami de l\'Ombre', icon: 'ğŸŒ™', desc: '20 check-ins Ã  l\'ombre', condition: s => s.shadeCheckins >= 20 },
      weather_warrior: { id: 'weather_warrior', name: 'Guerrier MÃ©tÃ©o', icon: 'ğŸŒ§ï¸', desc: 'Check-in par temps nuageux', condition: s => s.cloudyCheckins >= 1 },
      
      // Challenge badges
      challenge_master: { id: 'challenge_master', name: 'MaÃ®tre des DÃ©fis', icon: 'ğŸ¯', desc: '10 dÃ©fis complÃ©tÃ©s', condition: s => (s.challengesCompleted || 0) >= 10 },
      daily_champion: { id: 'daily_champion', name: 'Champion du Jour', icon: 'ğŸ…', desc: 'Tous les dÃ©fis en 1 jour', condition: s => s.perfectDayCount >= 1 },
      
      // Social badges
      social_butterfly: { id: 'social_butterfly', name: 'Papillon Social', icon: 'ğŸ¦‹', desc: 'Partager l\'app', condition: s => s.shareCount >= 1 },
      recruiter: { id: 'recruiter', name: 'Parrain', icon: 'ğŸ¤', desc: 'Inviter 3 amis', condition: s => (s.referralCount || 0) >= 3 }
    };
    
    // Initialize extra counters
    userStats.goldenHourCheckins = 0;
    userStats.cloudyCheckins = 0;
    userStats.maxStreak = 0;

    // ==========================================
    // GEOLOCATION
    // ==========================================
    function initGeolocation() {
      if (!navigator.geolocation) {
        console.log('GÃ©olocalisation non supportÃ©e');
        return;
      }
      
      // Watch position for real-time updates
      watchPositionId = navigator.geolocation.watchPosition(
        (position) => {
          userLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
            accuracy: position.coords.accuracy
          };
          updateUserMarker();
          updateUI(); // Refresh distances
          console.log('ğŸ“ Position mise Ã  jour:', userLocation);
        },
        (error) => {
          console.log('Erreur gÃ©oloc:', error.message);
          document.getElementById('geoStatus').textContent = 'ğŸ“ Position indisponible';
        },
        { enableHighAccuracy: true, maximumAge: 30000, timeout: 10000 }
      );
    }
    
    function centerOnUser() {
      if (userLocation) {
        map.panTo({ lat: userLocation.lat, lng: userLocation.lng });
        map.setZoom(16);
      } else {
        // Request location
        navigator.geolocation.getCurrentPosition(
          (position) => {
            userLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
              accuracy: position.coords.accuracy
            };
            map.panTo({ lat: userLocation.lat, lng: userLocation.lng });
            map.setZoom(16);
            updateUserMarker();
            updateUI();
          },
          (error) => {
            alert('Impossible d\'obtenir votre position. VÃ©rifiez les permissions.');
          },
          { enableHighAccuracy: true }
        );
      }
    }
    
    function updateUserMarker() {
      if (!userLocation || !map) return;
      
      if (userMarker) {
        userMarker.setPosition({ lat: userLocation.lat, lng: userLocation.lng });
      } else {
        // Create user marker with pulsing effect
        userMarker = new google.maps.Marker({
          position: { lat: userLocation.lat, lng: userLocation.lng },
          map: map,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 12,
            fillColor: '#3B82F6',
            fillOpacity: 1,
            strokeColor: '#fff',
            strokeWeight: 3,
          },
          title: 'Vous Ãªtes ici',
          zIndex: 1000
        });
        
        // Add accuracy circle
        new google.maps.Circle({
          map: map,
          center: { lat: userLocation.lat, lng: userLocation.lng },
          radius: userLocation.accuracy || 50,
          fillColor: '#3B82F6',
          fillOpacity: 0.1,
          strokeColor: '#3B82F6',
          strokeOpacity: 0.3,
          strokeWeight: 1
        });
      }
      
      document.getElementById('geoStatus').innerHTML = 'ğŸ“ <span class="text-green-600 font-medium">Position active</span>';
    }
    
    function getDistanceFromUser(bar) {
      if (!userLocation) return null;
      
      const R = 6371e3; // Earth radius in meters
      const Ï†1 = userLocation.lat * Math.PI / 180;
      const Ï†2 = bar.lat * Math.PI / 180;
      const Î”Ï† = (bar.lat - userLocation.lat) * Math.PI / 180;
      const Î”Î» = (bar.lng - userLocation.lng) * Math.PI / 180;
      
      const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                Math.cos(Ï†1) * Math.cos(Ï†2) *
                Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      
      return R * c; // Distance in meters
    }
    
    function formatDistance(meters) {
      if (meters === null) return '';
      if (meters < 1000) return `${Math.round(meters)}m`;
      return `${(meters / 1000).toFixed(1)}km`;
    }
    
    function openDirections(bar) {
      const url = `https://www.google.com/maps/dir/?api=1&destination=${bar.lat},${bar.lng}&travelmode=walking`;
      window.open(url, '_blank');
    }

    // ==========================================
    // WEATHER API
    // ==========================================
    async function fetchWeather() {
      try {
        const response = await fetch(
          `https://weather.googleapis.com/v1/currentConditions:lookup?key=${GOOGLE_MAPS_API_KEY}&location.latitude=48.8566&location.longitude=2.3522`
        );
        if (response.ok) {
          weatherData = await response.json();
          updateWeatherUI();
          createMarkers();
          updateUI();
          console.log('MÃ©tÃ©o chargÃ©e:', weatherData);
        } else {
          console.log('Weather API non disponible, utilisation du mode soleil uniquement');
        }
      } catch (error) {
        console.log('Erreur mÃ©tÃ©o:', error);
      }
    }

    function getCloudCover() {
      if (!weatherData) return 0;
      // Google Weather API returns cloud cover as percentage
      return weatherData.cloudCover || 0;
    }

    function getWeatherCondition() {
      if (!weatherData) return 'clear';
      const code = weatherData.weatherCondition?.type || '';
      if (code.includes('RAIN') || code.includes('STORM')) return 'rain';
      if (code.includes('CLOUD') || code.includes('OVERCAST')) return 'cloudy';
      if (code.includes('FOG') || code.includes('MIST')) return 'fog';
      return 'clear';
    }

    function updateWeatherUI() {
      const weatherEl = document.getElementById('weatherInfo');
      if (!weatherData || !weatherEl) return;
      
      const temp = weatherData.temperature?.degrees || '--';
      const condition = getWeatherCondition();
      const cloudCover = getCloudCover();
      
      let icon = 'â˜€ï¸';
      let label = 'EnsoleillÃ©';
      if (condition === 'rain') { icon = 'ğŸŒ§ï¸'; label = 'Pluie'; }
      else if (condition === 'cloudy' || cloudCover > 50) { icon = 'â˜ï¸'; label = 'Nuageux'; }
      else if (condition === 'fog') { icon = 'ğŸŒ«ï¸'; label = 'Brouillard'; }
      else if (cloudCover > 20) { icon = 'â›…'; label = 'Partiellement nuageux'; }
      
      weatherEl.innerHTML = `
        <span class="text-2xl">${icon}</span>
        <div>
          <div class="font-bold">${Math.round(temp)}Â°C</div>
          <div class="text-xs opacity-70">${label}</div>
        </div>
      `;
    }

    // ==========================================
    // SUN CALCULATIONS
    // ==========================================
    function getSunPosition(date, lat = 48.8566, lng = 2.3522) {
      const rad = Math.PI / 180;
      const dayOfYear = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 86400000);
      const hour = date.getHours() + date.getMinutes() / 60;
      const declination = -23.45 * Math.cos(rad * 360 / 365 * (dayOfYear + 10));
      const solarNoon = 12 - lng / 15 + (date.getTimezoneOffset() / 60);
      const hourAngle = 15 * (hour - solarNoon);
      const sinAlt = Math.sin(rad * lat) * Math.sin(rad * declination) +
                     Math.cos(rad * lat) * Math.cos(rad * declination) * Math.cos(rad * hourAngle);
      const altitude = Math.asin(sinAlt) / rad;
      const cosAz = (Math.sin(rad * declination) - Math.sin(rad * lat) * sinAlt) /
                    (Math.cos(rad * lat) * Math.cos(Math.asin(sinAlt)));
      let azimuth = Math.acos(Math.max(-1, Math.min(1, cosAz))) / rad;
      if (hour > solarNoon) azimuth = 360 - azimuth;
      return { altitude, azimuth };
    }

    const ORIENTATIONS = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
    const ORIENTATION_ANGLES = { N: 0, NE: 45, E: 90, SE: 135, S: 180, SW: 225, W: 270, NW: 315 };

    function getTerraceOrientation(id) {
      return ORIENTATIONS[(id * 7 + 3) % 8];
    }

    function getBarSunStatus(bar) {
      if (!bar.hasTerrasse) return 'noTerrace';
      const sun = getSunPosition(currentTime);
      if (sun.altitude < 5) return 'night';
      
      // Check weather conditions
      const cloudCover = getCloudCover();
      const condition = getWeatherCondition();
      
      // If heavy clouds or rain, everything is in shade
      if (condition === 'rain' || condition === 'fog' || cloudCover > 80) return 'shade';
      
      const terraceAngle = ORIENTATION_ANGLES[getTerraceOrientation(bar.id)];
      let angleDiff = Math.abs(sun.azimuth - terraceAngle);
      if (angleDiff > 180) angleDiff = 360 - angleDiff;
      
      const altitudeBonus = sun.altitude > 30 ? 20 : 0;
      
      // Adjust for partial clouds
      if (cloudCover > 50) {
        // With significant clouds, reduce sunny to partial
        if (angleDiff < (60 + altitudeBonus)) return 'partial';
        return 'shade';
      }
      
      if (angleDiff < (60 + altitudeBonus)) return 'sunny';
      if (angleDiff < (90 + altitudeBonus)) return 'partial';
      return 'shade';
    }

    function getSunshineScore(bar) {
      if (!bar.hasTerrasse) return 0;
      const sun = getSunPosition(currentTime);
      if (sun.altitude < 5) return 0;
      
      const terraceAngle = ORIENTATION_ANGLES[getTerraceOrientation(bar.id)];
      let angleDiff = Math.abs(sun.azimuth - terraceAngle);
      if (angleDiff > 180) angleDiff = 360 - angleDiff;
      
      const orientationScore = Math.max(0, 100 - angleDiff);
      const altitudeScore = Math.min(100, sun.altitude * 2);
      let score = Math.round((orientationScore * 0.7 + altitudeScore * 0.3));
      
      // Reduce score based on cloud cover
      const cloudCover = getCloudCover();
      if (cloudCover > 0) {
        score = Math.round(score * (1 - cloudCover / 100));
      }
      
      return score;
    }

    function getMarkerColor(status) {
      switch(status) {
        case 'sunny': return '#FFD700';
        case 'partial': return '#FFA500';
        case 'shade': return '#4A90D9';
        case 'night': return '#6B7280';
        case 'noTerrace': return '#1F2937';
        default: return '#6B7280';
      }
    }

    function getStatusLabel(status) {
      switch(status) {
        case 'sunny': return 'â˜€ï¸ Au soleil';
        case 'partial': return 'â›… Partiellement';
        case 'shade': return 'ğŸŒ¥ï¸ Ã€ l\'ombre';
        case 'night': return 'ğŸŒ™ Nuit';
        case 'noTerrace': return 'ğŸ  Sans terrasse';
        default: return '';
      }
    }

    // ==========================================
    // GOOGLE MAPS
    // ==========================================
    function initMap() {
      // Try to create map with 3D features
      const mapOptions = {
        center: { lat: 48.8566, lng: 2.3522 },
        zoom: 16,
        // Enable 3D buildings (works on satellite/hybrid views)
        tilt: 45,
        heading: 0,
        mapTypeId: 'roadmap',
        styles: [
          { featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] },
          { featureType: "transit", elementType: "labels", stylers: [{ visibility: "off" }] }
        ],
        mapTypeControl: true,
        mapTypeControlOptions: {
          mapTypeIds: ['roadmap', 'satellite', 'hybrid'],
          position: google.maps.ControlPosition.TOP_RIGHT
        },
        streetViewControl: true,
        fullscreenControl: true,
        rotateControl: true,
        gestureHandling: 'greedy'
      };
      
      map = new google.maps.Map(document.getElementById('map'), mapOptions);
      
      // Initialize Directions Service
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        suppressMarkers: true,
        polylineOptions: {
          strokeColor: '#f59e0b',
          strokeWeight: 5,
          strokeOpacity: 0.8
        }
      });
      directionsRenderer.setMap(map);
      
      // Enable tilt and rotation controls
      map.setTilt(45);
      
      // Listen for map type changes to optimize 3D
      map.addListener('maptypeid_changed', () => {
        const mapType = map.getMapTypeId();
        // Satellite and hybrid have better 3D buildings
        if (mapType === 'satellite' || mapType === 'hybrid') {
          map.setTilt(45);
        }
      });

      // Add sun direction indicator on map
      createSunOverlay();
      
      // Load bars data from JSON file
      loadUserStats(); // Load saved progress
      loadBarsData().then(() => {
        updateTimeDisplay();
        updateSunPath();
        updatePredictionPanel();
        updateBadgeCount();
      });
      fetchWeather(); // Load real-time weather
      initGeolocation(); // Start tracking user location
      
      // Update sun overlay when time changes
      setInterval(updateSunOverlay, 1000);
    }
    
    // ==========================================
    // SUN SHADOW OVERLAY
    // ==========================================
    let sunOverlay = null;
    
    function createSunOverlay() {
      // Create a custom overlay for sun direction visualization
      const sunDiv = document.createElement('div');
      sunDiv.id = 'sunDirectionOverlay';
      sunDiv.style.cssText = `
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255,255,255,0.95);
        padding: 12px 16px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        font-family: Inter, sans-serif;
      `;
      document.getElementById('map').appendChild(sunDiv);
      updateSunOverlay();
    }
    
    function updateSunOverlay() {
      const sun = getSunPosition(currentTime);
      const overlay = document.getElementById('sunDirectionOverlay');
      if (!overlay) return;
      
      const isDay = sun.altitude > 0;
      const sunIcon = isDay ? 'â˜€ï¸' : 'ğŸŒ™';
      const shadowLength = isDay ? Math.max(1, 10 / Math.tan(sun.altitude * Math.PI / 180)).toFixed(1) : 'âˆ';
      
      // Rotate map heading to align with sun (optional effect)
      // map.setHeading(sun.azimuth);
      
      overlay.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
          <div style="font-size: 28px; transform: rotate(${sun.azimuth}deg);">â¡ï¸</div>
          <div>
            <div style="font-weight: 700; color: #78350f; font-size: 14px;">
              ${sunIcon} Direction du soleil
            </div>
            <div style="font-size: 12px; color: #92400e;">
              Azimut: ${sun.azimuth.toFixed(0)}Â° â€¢ Alt: ${sun.altitude.toFixed(0)}Â°
            </div>
            <div style="font-size: 11px; color: #a16207;">
              Longueur ombres: ${shadowLength}x hauteur
            </div>
          </div>
        </div>
        <div style="margin-top: 8px; display: flex; gap: 4px;">
          <button onclick="rotateTilt(-15)" style="padding: 4px 8px; border-radius: 6px; border: 1px solid #d97706; background: #fef3c7; cursor: pointer; font-size: 11px;">â¬…ï¸ Rotation</button>
          <button onclick="rotateTilt(15)" style="padding: 4px 8px; border-radius: 6px; border: 1px solid #d97706; background: #fef3c7; cursor: pointer; font-size: 11px;">Rotation â¡ï¸</button>
          <button onclick="toggleTilt()" style="padding: 4px 8px; border-radius: 6px; border: 1px solid #d97706; background: #fef3c7; cursor: pointer; font-size: 11px;">ğŸ™ï¸ 2D/3D</button>
          <button onclick="alignWithSun()" style="padding: 4px 8px; border-radius: 6px; border: 1px solid #d97706; background: #fef3c7; cursor: pointer; font-size: 11px;">â˜€ï¸ Aligner soleil</button>
        </div>
      `;
      
      // Update ground shadow overlay
      updateGroundShadow(sun);
    }
    
    function rotateTilt(degrees) {
      const currentHeading = map.getHeading() || 0;
      map.setHeading(currentHeading + degrees);
    }
    
    function toggleTilt() {
      const currentTilt = map.getTilt() || 0;
      map.setTilt(currentTilt > 0 ? 0 : 45);
    }
    
    function alignWithSun() {
      const sun = getSunPosition(currentTime);
      // Rotate map so sun comes from the top
      map.setHeading(sun.azimuth - 180);
      map.setTilt(45);
    }
    
    // Ground shadow visualization
    let shadowOverlay = null;
    
    function updateGroundShadow(sun) {
      // Remove existing shadow overlay
      if (shadowOverlay) {
        shadowOverlay.setMap(null);
      }
      
      if (sun.altitude <= 0) return; // No shadows at night
      
      // Create gradient overlay to simulate sun direction
      const bounds = map.getBounds();
      if (!bounds) return;
      
      // Shadow direction is opposite to sun azimuth
      const shadowAzimuth = (sun.azimuth + 180) % 360;
      
      // We'll create a subtle gradient overlay showing light direction
      // This is a simplified visualization - real shadows would need 3D building data
      
      class SunGradientOverlay extends google.maps.OverlayView {
        constructor(azimuth, altitude) {
          super();
          this.azimuth = azimuth;
          this.altitude = altitude;
        }
        
        onAdd() {
          this.div = document.createElement('div');
          this.div.style.cssText = `
            position: absolute;
            pointer-events: none;
          `;
          const panes = this.getPanes();
          panes.overlayLayer.appendChild(this.div);
        }
        
        draw() {
          const overlayProjection = this.getProjection();
          const bounds = map.getBounds();
          if (!bounds || !overlayProjection) return;
          
          const sw = overlayProjection.fromLatLngToDivPixel(bounds.getSouthWest());
          const ne = overlayProjection.fromLatLngToDivPixel(bounds.getNorthEast());
          
          if (!sw || !ne) return;
          
          const width = ne.x - sw.x;
          const height = sw.y - ne.y;
          
          // Sun intensity based on altitude (higher = brighter)
          const intensity = Math.min(0.15, (90 - this.altitude) / 600);
          
          // Gradient angle based on sun azimuth
          const gradientAngle = this.azimuth + 90;
          
          this.div.style.left = sw.x + 'px';
          this.div.style.top = ne.y + 'px';
          this.div.style.width = width + 'px';
          this.div.style.height = height + 'px';
          this.div.style.background = `linear-gradient(${gradientAngle}deg, 
            rgba(0,0,0,${intensity}) 0%, 
            rgba(255,200,50,0.05) 50%,
            rgba(255,255,200,0.1) 100%)`;
        }
        
        onRemove() {
          if (this.div) {
            this.div.parentNode.removeChild(this.div);
            this.div = null;
          }
        }
      }
      
      shadowOverlay = new SunGradientOverlay(sun.azimuth, sun.altitude);
      shadowOverlay.setMap(map);
    }

    function createMarkers() {
      // Wait for data to be loaded
      if (!dataLoaded || BARS_DATA.length === 0) return;
      
      // Clear existing markers
      markers.forEach(m => m.setMap(null));
      markers = [];
      
      // Clear clusterer if exists
      if (markerClusterer) {
        markerClusterer.clearMarkers();
      }

      const filteredBars = getFilteredBars();
      
      // Performance: limit markers on map if too many
      const maxMarkers = 1000;
      const barsToShow = filteredBars.length > maxMarkers 
        ? filteredBars.slice(0, maxMarkers) 
        : filteredBars;
      
      // Prepare heatmap data
      const heatmapData = [];

      barsToShow.forEach(bar => {
        const status = getBarSunStatus(bar);
        const color = getMarkerColor(status);
        const score = getSunshineScore(bar);
        const isSunny = status === 'sunny';
        
        // Add to heatmap data if sunny
        if (bar.hasTerrasse && score > 0) {
          heatmapData.push({
            location: new google.maps.LatLng(bar.lat, bar.lng),
            weight: score / 100
          });
        }

        // Create custom marker
        const marker = new google.maps.Marker({
          position: { lat: bar.lat, lng: bar.lng },
          map: showClusters ? null : map, // Don't add to map if clustering
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: isSunny ? 12 : 8,
            fillColor: color,
            fillOpacity: 1,
            strokeColor: '#fff',
            strokeWeight: isSunny ? 3 : 2,
          },
          title: bar.name,
          zIndex: isSunny ? 100 : (status === 'partial' ? 50 : 10)
        });

        // Info window
        const distance = getDistanceFromUser(bar);
        const distanceText = formatDistance(distance);
        const infoContent = `
          <div class="info-window">
            <h3 style="font-weight: bold; font-size: 14px; margin-bottom: 4px;">${bar.name}</h3>
            <p style="color: ${color}; font-weight: 600; margin-bottom: 4px;">${getStatusLabel(status)} ${bar.hasTerrasse && score > 0 ? `(${score}%)` : ''}</p>
            <div style="display: flex; gap: 8px; font-size: 12px; color: #666; margin-bottom: 4px;">
              <span>â­ ${bar.rating || '-'}</span>
              <span>ğŸ’¬ ${bar.reviews || 0}</span>
              <span>${bar.price || 'â‚¬â‚¬'}</span>
            </div>
            ${distanceText ? `<p style="color: #3B82F6; font-size: 12px; font-weight: 600; margin-bottom: 8px;">ğŸ“ ${distanceText}</p>` : ''}
            <div style="display: flex; gap: 6px;">
              <button onclick="showBarDetail(${bar.id})" style="flex: 1; padding: 6px 12px; background: linear-gradient(to right, #9333ea, #ec4899); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 12px;">
                DÃ©tails
              </button>
              <button onclick="showRouteToBar(BARS_DATA.find(b => b.id === ${bar.id}))" style="padding: 6px 12px; background: #3B82F6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 12px;">
                ğŸ§­ Trajet
              </button>
            </div>
          </div>
        `;

        const infoWindow = new google.maps.InfoWindow({ content: infoContent });

        marker.addListener('click', () => {
          infoWindow.open(map, marker);
        });

        markers.push(marker);
      });
      
      // Setup marker clusterer
      if (showClusters && typeof markerClusterer !== 'undefined') {
        setupMarkerClusterer();
      } else {
        // Show markers directly if no clustering
        markers.forEach(m => m.setMap(map));
      }
      
      // Update heatmap
      updateHeatmapLayer(heatmapData);
    }
    
    // ==========================================
    // MARKER CLUSTERING
    // ==========================================
    function setupMarkerClusterer() {
      if (markerClusterer) {
        markerClusterer.clearMarkers();
      }
      
      // Check if MarkerClusterer library is loaded
      if (typeof markerClusterer === 'undefined' && window.markerClusterer) {
        // Library loaded via CDN
      }
      
      try {
        markerClusterer = new markerClusterer.MarkerClusterer({
          map: map,
          markers: markers,
          renderer: {
            render: ({ count, position }) => {
              // Custom cluster icon based on count
              const size = count > 50 ? 50 : (count > 20 ? 40 : 30);
              const color = count > 50 ? '#ef4444' : (count > 20 ? '#f59e0b' : '#22c55e');
              
              return new google.maps.Marker({
                position,
                icon: {
                  path: google.maps.SymbolPath.CIRCLE,
                  scale: size / 2,
                  fillColor: color,
                  fillOpacity: 0.9,
                  strokeColor: '#fff',
                  strokeWeight: 3,
                },
                label: {
                  text: String(count),
                  color: '#fff',
                  fontWeight: 'bold',
                  fontSize: '12px'
                },
                zIndex: 1000 + count
              });
            }
          }
        });
      } catch (e) {
        // Fallback: show markers without clustering
        console.log('Clustering not available, showing all markers');
        markers.forEach(m => m.setMap(map));
      }
    }
    
    function toggleClusters() {
      showClusters = !showClusters;
      
      if (showClusters) {
        setupMarkerClusterer();
      } else {
        if (markerClusterer) {
          markerClusterer.clearMarkers();
        }
        markers.forEach(m => m.setMap(map));
      }
      
      // Update button state
      const btn = document.getElementById('clusterToggle');
      if (btn) {
        btn.classList.toggle('bg-amber-500', showClusters);
        btn.classList.toggle('text-white', showClusters);
        btn.classList.toggle('bg-white', !showClusters);
        btn.classList.toggle('text-gray-700', !showClusters);
      }
      
      triggerHaptic('light');
    }
    
    // ==========================================
    // HEATMAP LAYER
    // ==========================================
    function updateHeatmapLayer(data) {
      // Remove existing heatmap
      if (heatmapLayer) {
        heatmapLayer.setMap(null);
      }
      
      if (!showHeatmap || data.length === 0) return;
      
      heatmapLayer = new google.maps.visualization.HeatmapLayer({
        data: data,
        map: map,
        radius: 50,
        opacity: 0.6,
        gradient: [
          'rgba(255, 255, 255, 0)',
          'rgba(255, 237, 179, 0.5)',
          'rgba(253, 224, 71, 0.7)',
          'rgba(250, 204, 21, 0.8)',
          'rgba(245, 158, 11, 0.9)',
          'rgba(234, 88, 12, 1)'
        ]
      });
    }
    
    function toggleHeatmap() {
      showHeatmap = !showHeatmap;
      createMarkers(); // Refresh to show/hide heatmap
      
      // Update button state
      const btn = document.getElementById('heatmapToggle');
      if (btn) {
        btn.classList.toggle('bg-amber-500', showHeatmap);
        btn.classList.toggle('text-white', showHeatmap);
        btn.classList.toggle('bg-white', !showHeatmap);
        btn.classList.toggle('text-gray-700', !showHeatmap);
      }
      
      triggerHaptic('light');
    }
    
    // ==========================================
    // DIRECTIONS / ROUTE ON MAP
    // ==========================================
    function showRouteToBar(bar) {
      if (!bar) return;
      
      if (!userLocation) {
        alert('Activez la gÃ©olocalisation pour voir l\'itinÃ©raire');
        initGeolocation();
        return;
      }
      
      const request = {
        origin: new google.maps.LatLng(userLocation.lat, userLocation.lng),
        destination: new google.maps.LatLng(bar.lat, bar.lng),
        travelMode: google.maps.TravelMode.WALKING
      };
      
      directionsService.route(request, (result, status) => {
        if (status === google.maps.DirectionsStatus.OK) {
          directionsRenderer.setDirections(result);
          
          // Show route info
          const route = result.routes[0].legs[0];
          showRouteInfo(bar, route);
          
          triggerHaptic('success');
        } else {
          console.error('Directions request failed:', status);
          // Fallback to Google Maps
          openDirections(bar);
        }
      });
    }
    
    function showRouteInfo(bar, route) {
      // Show clear route button
      const clearBtn = document.getElementById('clearRouteBtn');
      if (clearBtn) clearBtn.classList.remove('hidden');
      
      // Create or update route info panel
      let routePanel = document.getElementById('routeInfoPanel');
      
      if (!routePanel) {
        routePanel = document.createElement('div');
        routePanel.id = 'routeInfoPanel';
        routePanel.className = 'fixed bottom-20 left-4 right-4 md:left-auto md:right-4 md:w-80 z-[60] bg-white rounded-2xl shadow-2xl p-4 transform transition-all';
        document.body.appendChild(routePanel);
      }
      
      const status = getBarSunStatus(bar);
      const color = getMarkerColor(status);
      
      routePanel.innerHTML = `
        <div class="flex items-start justify-between mb-3">
          <div>
            <h3 class="font-bold text-gray-800">${bar.name}</h3>
            <p class="text-sm" style="color: ${color}">${getStatusLabel(status)}</p>
          </div>
          <button onclick="clearRoute()" class="p-2 hover:bg-gray-100 rounded-full">
            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
          </button>
        </div>
        <div class="flex items-center gap-4 mb-4">
          <div class="flex items-center gap-2 text-gray-600">
            <span class="text-xl">ğŸš¶</span>
            <div>
              <p class="font-bold text-lg text-gray-800">${route.duration.text}</p>
              <p class="text-sm text-gray-500">${route.distance.text}</p>
            </div>
          </div>
        </div>
        <div class="flex gap-2">
          <button onclick="showBarDetail(${bar.id})" class="flex-1 py-3 rounded-xl font-bold text-amber-600 bg-amber-50 hover:bg-amber-100 transition">
            Voir dÃ©tails
          </button>
          <button onclick="openDirections(BARS_DATA.find(b => b.id === ${bar.id}))" class="flex-1 py-3 rounded-xl font-bold text-white bg-blue-500 hover:bg-blue-600 transition">
            Google Maps
          </button>
        </div>
      `;
      
      routePanel.style.display = 'block';
    }
    
    function clearRoute() {
      if (directionsRenderer) {
        directionsRenderer.setDirections({ routes: [] });
      }
      
      const routePanel = document.getElementById('routeInfoPanel');
      if (routePanel) {
        routePanel.style.display = 'none';
      }
      
      // Hide clear route button
      const clearBtn = document.getElementById('clearRouteBtn');
      if (clearBtn) clearBtn.classList.add('hidden');
      
      triggerHaptic('light');
    }
    
    // ==========================================
    // DAILY CHALLENGES SYSTEM
    // ==========================================
    function initDailyChallenges() {
      const today = new Date().toDateString();
      const savedProgress = localStorage.getItem('spotTheSun_dailyProgress');
      
      if (savedProgress) {
        const parsed = JSON.parse(savedProgress);
        if (parsed.date === today) {
          dailyProgress = {
            ...parsed,
            arrondissementsToday: new Set(parsed.arrondissementsToday || []),
            completedChallenges: new Set(parsed.completedChallenges || [])
          };
        } else {
          // New day, reset progress
          resetDailyProgress();
        }
      } else {
        resetDailyProgress();
      }
      
      // Generate today's challenges (3 random ones)
      generateDailyChallenges();
      updateChallengesUI();
    }
    
    function resetDailyProgress() {
      dailyProgress = {
        date: new Date().toDateString(),
        sunnyVisits: 0,
        totalVisits: 0,
        arrondissementsToday: new Set(),
        earlyVisit: false,
        goldenVisit: false,
        streakKept: false,
        distanceWalked: 0,
        lastBarLocation: null,
        completedChallenges: new Set(),
        xpEarned: 0
      };
      saveDailyProgress();
    }
    
    function saveDailyProgress() {
      const toSave = {
        ...dailyProgress,
        arrondissementsToday: Array.from(dailyProgress.arrondissementsToday),
        completedChallenges: Array.from(dailyProgress.completedChallenges)
      };
      localStorage.setItem('spotTheSun_dailyProgress', JSON.stringify(toSave));
    }
    
    function generateDailyChallenges() {
      // Use date as seed for consistent daily challenges
      const seed = new Date().toDateString();
      const shuffled = [...CHALLENGE_TYPES].sort(() => {
        return seed.charCodeAt(0) + seed.charCodeAt(1) - 0.5;
      });
      
      // Pick 3 challenges
      dailyChallenges = shuffled.slice(0, 3).map(c => ({
        ...c,
        progress: 0,
        completed: dailyProgress.completedChallenges.has(c.id),
        xpReward: c.target >= 5 ? 100 : 50
      }));
      
      updateChallengeProgress();
    }
    
    function updateChallengeProgress() {
      dailyChallenges.forEach(challenge => {
        switch(challenge.type) {
          case 'sunny':
            challenge.progress = dailyProgress.sunnyVisits;
            break;
          case 'total':
            challenge.progress = dailyProgress.totalVisits;
            break;
          case 'arrondissements':
            challenge.progress = dailyProgress.arrondissementsToday.size;
            break;
          case 'early':
            challenge.progress = dailyProgress.earlyVisit ? 1 : 0;
            break;
          case 'golden':
            challenge.progress = dailyProgress.goldenVisit ? 1 : 0;
            break;
          case 'streak':
            challenge.progress = userStats.streak > 0 ? 1 : 0;
            break;
          case 'distance':
            challenge.progress = dailyProgress.distanceWalked;
            break;
        }
        
        // Check completion
        if (!challenge.completed && challenge.progress >= challenge.target) {
          completeChallenge(challenge);
        }
      });
    }
    
    function completeChallenge(challenge) {
      if (challenge.completed) return;
      
      challenge.completed = true;
      dailyProgress.completedChallenges.add(challenge.id);
      
      // Track total challenges completed for badge
      userStats.challengesCompleted = (userStats.challengesCompleted || 0) + 1;
      
      // Check if all daily challenges completed (perfect day)
      const allCompleted = dailyChallenges.every(c => c.completed);
      if (allCompleted) {
        userStats.perfectDayCount = (userStats.perfectDayCount || 0) + 1;
      }
      
      // Apply streak multiplier
      const multiplier = 1 + (userStats.streak * 0.1);
      const xpEarned = Math.round(challenge.xpReward * multiplier);
      
      // Award XP
      userStats.xp += xpEarned;
      dailyProgress.xpEarned += xpEarned;
      
      // Check level up
      const newLevel = Math.floor(userStats.xp / 500) + 1;
      if (newLevel > userStats.level) {
        userStats.level = newLevel;
        showLevelUpToast(newLevel);
      }
      
      // Show completion toast
      showChallengeCompleteToast(challenge, xpEarned);
      
      // Haptic feedback
      triggerHaptic('success');
      
      saveUserStats();
      saveDailyProgress();
      updateChallengesUI();
      updateUI();
    }
    
    function showChallengeCompleteToast(challenge, xp) {
      const toast = document.getElementById('challengeToast');
      document.getElementById('challengeToastIcon').textContent = challenge.icon;
      document.getElementById('challengeToastTitle').textContent = challenge.name + ' complÃ©tÃ© !';
      document.getElementById('challengeToastXp').textContent = '+' + xp + ' XP';
      
      toast.classList.remove('hidden');
      
      setTimeout(() => {
        toast.classList.add('hidden');
      }, 3000);
    }
    
    function showLevelUpToast(level) {
      // Reuse badge toast for level up
      const toast = document.getElementById('badgeToast');
      if (toast) {
        document.getElementById('badgeToastIcon').textContent = 'â¬†ï¸';
        document.getElementById('badgeToastName').textContent = 'Niveau ' + level + ' !';
        document.getElementById('badgeToastDesc').textContent = 'Tu progresses !';
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 3000);
      }
    }
    
    function updateChallengesUI() {
      // Update floating panel
      const listContainer = document.getElementById('challengesList');
      const modalList = document.getElementById('modalChallengesList');
      
      const challengesHTML = dailyChallenges.map(c => {
        const percent = Math.min((c.progress / c.target) * 100, 100);
        return `
          <div class="bg-gray-50 rounded-xl p-3 ${c.completed ? 'ring-2 ring-green-400 bg-green-50' : ''}">
            <div class="flex items-center gap-3">
              <div class="text-2xl">${c.icon}</div>
              <div class="flex-1 min-w-0">
                <p class="font-bold text-sm text-gray-800 ${c.completed ? 'line-through text-green-600' : ''}">${c.name}</p>
                <p class="text-xs text-gray-500">${c.desc}</p>
              </div>
              <div class="text-right">
                <p class="text-xs font-bold ${c.completed ? 'text-green-500' : 'text-purple-600'}">${c.completed ? 'âœ…' : '+' + c.xpReward + ' XP'}</p>
              </div>
            </div>
            <div class="mt-2 h-2 bg-gray-200 rounded-full overflow-hidden">
              <div class="h-full rounded-full transition-all duration-500 ${c.completed ? 'bg-green-400' : 'bg-gradient-to-r from-purple-500 to-pink-500'}" style="width: ${percent}%"></div>
            </div>
            <p class="text-xs text-gray-400 mt-1 text-right">${Math.min(c.progress, c.target)}/${c.target}</p>
          </div>
        `;
      }).join('');
      
      if (listContainer) listContainer.innerHTML = challengesHTML;
      if (modalList) modalList.innerHTML = challengesHTML;
      
      // Update counts
      const completed = dailyChallenges.filter(c => c.completed).length;
      document.getElementById('modalCompletedCount').textContent = `${completed}/${dailyChallenges.length}`;
      document.getElementById('modalDailyXp').textContent = `+${dailyProgress.xpEarned} XP`;
      document.getElementById('dailyXpCount').textContent = `+${dailyProgress.xpEarned} XP`;
      
      // Update streak display
      document.getElementById('currentStreakDisplay').textContent = userStats.streak || 0;
      document.getElementById('streakMultiplier').textContent = (1 + (userStats.streak * 0.1)).toFixed(1);
      
      // Update timer
      updateChallengeTimer();
    }
    
    function updateChallengeTimer() {
      const now = new Date();
      const midnight = new Date(now);
      midnight.setHours(24, 0, 0, 0);
      const hoursLeft = Math.ceil((midnight - now) / (1000 * 60 * 60));
      
      const timerText = hoursLeft + 'h restant';
      const timerEl = document.getElementById('challengesTimer');
      const modalTimer = document.getElementById('modalTimer');
      
      if (timerEl) timerEl.textContent = 'Renouvellement dans ' + hoursLeft + 'h';
      if (modalTimer) modalTimer.textContent = hoursLeft + 'h';
    }
    
    function toggleChallengesPanel() {
      const panel = document.getElementById('challengesPanel');
      panel.classList.toggle('hidden');
    }
    
    function showChallengesModal() {
      document.getElementById('challengesModal').classList.remove('hidden');
      document.getElementById('challengesModal').classList.add('flex');
      updateChallengesUI();
      triggerHaptic('light');
    }
    
    function closeChallengesModal() {
      document.getElementById('challengesModal').classList.add('hidden');
      document.getElementById('challengesModal').classList.remove('flex');
    }
    
    // Update checkin to track daily progress
    function trackDailyCheckin(bar, isSunny) {
      dailyProgress.totalVisits++;
      
      if (isSunny) {
        dailyProgress.sunnyVisits++;
      }
      
      // Track arrondissement
      const arr = getArrondissement(bar.lat, bar.lng);
      if (arr) {
        dailyProgress.arrondissementsToday.add(arr);
      }
      
      // Track time-based
      const hour = new Date().getHours();
      if (hour < 11) {
        dailyProgress.earlyVisit = true;
      }
      if (hour >= 17 && hour < 19) {
        dailyProgress.goldenVisit = true;
      }
      
      // Track distance
      if (dailyProgress.lastBarLocation && userLocation) {
        const dist = getDistanceFromUser(dailyProgress.lastBarLocation);
        if (dist) {
          dailyProgress.distanceWalked += dist;
        }
      }
      dailyProgress.lastBarLocation = { lat: bar.lat, lng: bar.lng };
      
      saveDailyProgress();
      updateChallengeProgress();
      updateChallengesUI();
    }
    
    // ==========================================
    // LEADERBOARD SYSTEM
    // ==========================================
    function showLeaderboardModal() {
      document.getElementById('leaderboardModal').classList.remove('hidden');
      document.getElementById('leaderboardModal').classList.add('flex');
      updateLeaderboard('weekly');
      triggerHaptic('light');
    }
    
    function closeLeaderboardModal() {
      document.getElementById('leaderboardModal').classList.add('hidden');
      document.getElementById('leaderboardModal').classList.remove('flex');
    }
    
    function showLeaderboardTab(tab) {
      document.getElementById('tabWeekly').classList.toggle('text-amber-600', tab === 'weekly');
      document.getElementById('tabWeekly').classList.toggle('border-amber-500', tab === 'weekly');
      document.getElementById('tabWeekly').classList.toggle('border-b-2', tab === 'weekly');
      document.getElementById('tabWeekly').classList.toggle('text-gray-400', tab !== 'weekly');
      
      document.getElementById('tabAlltime').classList.toggle('text-amber-600', tab === 'alltime');
      document.getElementById('tabAlltime').classList.toggle('border-amber-500', tab === 'alltime');
      document.getElementById('tabAlltime').classList.toggle('border-b-2', tab === 'alltime');
      document.getElementById('tabAlltime').classList.toggle('text-gray-400', tab !== 'alltime');
      
      updateLeaderboard(tab);
    }
    
    function updateLeaderboard(tab) {
      // Generate fake leaderboard (in real app, this would be from a server)
      const fakeUsers = [
        { name: 'SunSeeker42', xp: 3250, level: 7, avatar: 'ğŸ˜' },
        { name: 'ParisLover', xp: 2890, level: 6, avatar: 'ğŸ—¼' },
        { name: 'TerrasseKing', xp: 2450, level: 5, avatar: 'ğŸ‘‘' },
        { name: 'GoldenHour', xp: 2100, level: 5, avatar: 'ğŸŒ…' },
        { name: 'BarHopper', xp: 1850, level: 4, avatar: 'ğŸº' },
        { name: 'SunChaser', xp: 1620, level: 4, avatar: 'â˜€ï¸' },
        { name: 'CafÃ©Crawler', xp: 1400, level: 3, avatar: 'â˜•' },
        { name: 'NightOwl', xp: 1200, level: 3, avatar: 'ğŸ¦‰' },
      ];
      
      // Insert user somewhere
      const userXp = userStats.xp || 0;
      let userRank = 1;
      for (const u of fakeUsers) {
        if (userXp < u.xp) userRank++;
      }
      
      document.getElementById('yourRank').textContent = userRank;
      document.getElementById('yourXp').textContent = userXp;
      document.getElementById('yourLevel').textContent = userStats.level || 1;
      
      const listContainer = document.getElementById('leaderboardList');
      listContainer.innerHTML = fakeUsers.map((u, i) => {
        const rankColors = ['bg-yellow-400', 'bg-gray-300', 'bg-orange-400'];
        const rankColor = i < 3 ? rankColors[i] : 'bg-gray-100';
        
        return `
          <div class="flex items-center gap-3 p-3 rounded-xl ${i < 3 ? 'bg-gradient-to-r from-yellow-50 to-orange-50' : 'bg-gray-50'}">
            <div class="w-8 h-8 rounded-full ${rankColor} flex items-center justify-center font-bold text-sm ${i < 3 ? 'text-white' : 'text-gray-600'}">
              ${i + 1}
            </div>
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center text-xl">
              ${u.avatar}
            </div>
            <div class="flex-1">
              <p class="font-bold text-gray-800">${u.name}</p>
              <p class="text-xs text-gray-500">Niveau ${u.level}</p>
            </div>
            <div class="text-right">
              <p class="font-bold text-amber-600">${u.xp}</p>
              <p class="text-xs text-gray-400">XP</p>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function shareWithFriends() {
      const shareData = {
        title: 'Spot The Sun â˜€ï¸',
        text: 'Rejoins-moi sur Spot The Sun et trouve les meilleures terrasses ensoleillÃ©es de Paris !',
        url: window.location.href
      };
      
      // Track share for badge
      userStats.shareCount = (userStats.shareCount || 0) + 1;
      checkBadges();
      saveUserStats();
      
      if (navigator.share) {
        navigator.share(shareData).catch(console.error);
      } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(shareData.url + ' - ' + shareData.text);
        alert('Lien copiÃ© ! Partage-le avec tes amis ğŸ‰');
      }
      
      triggerHaptic('success');
    }

    function getFilteredBars() {
      const searchQuery = document.getElementById('searchInput').value.toLowerCase();
      
      return BARS_DATA.filter(bar => {
        // Search filter
        if (searchQuery && !bar.name.toLowerCase().includes(searchQuery)) return false;
        
        // Status filter
        const status = getBarSunStatus(bar);
        if (currentFilter === 'sunny') return status === 'sunny';
        if (currentFilter === 'shade') return status === 'shade' || status === 'partial';
        if (currentFilter === 'noTerrace') return !bar.hasTerrasse;
        if (currentFilter === 'terrace') return bar.hasTerrasse;
        
        return true;
      });
    }

    // ==========================================
    // UI UPDATES
    // ==========================================
    function updateUI() {
      // Wait for data to be loaded
      if (!dataLoaded || BARS_DATA.length === 0) return;
      
      const sun = getSunPosition(currentTime);
      
      // Update header
      document.getElementById('currentTime').textContent = currentTime.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
      document.getElementById('sunAltitude').textContent = `${sun.altitude.toFixed(0)}Â°`;
      document.getElementById('sunAzimuth').textContent = `${sun.azimuth.toFixed(0)}Â°`;

      // Count stats
      const sunny = BARS_DATA.filter(b => getBarSunStatus(b) === 'sunny').length;
      const shade = BARS_DATA.filter(b => ['shade', 'partial'].includes(getBarSunStatus(b))).length;
      const noTerrace = BARS_DATA.filter(b => !b.hasTerrasse).length;
      const terrace = BARS_DATA.filter(b => b.hasTerrasse).length;

      document.getElementById('countSunny').textContent = sunny;
      document.getElementById('countShade').textContent = shade;
      document.getElementById('countNoTerrace').textContent = noTerrace;
      document.getElementById('countTerrace').textContent = terrace;
      document.getElementById('countTotal').textContent = BARS_DATA.length;
      
      // Show weather impact in header
      const cloudCover = getCloudCover();
      const weatherNote = cloudCover > 50 ? ` â€¢ â˜ï¸ ${cloudCover}% nuages` : '';
      document.getElementById('statsHeader').textContent = `${BARS_DATA.length} bars Ã  Paris â€¢ ${sunny} au soleil â˜€ï¸${weatherNote}`;

      // Update user stats
      document.getElementById('userLevel').textContent = userStats.level;
      document.getElementById('userXP').textContent = userStats.xp;
      document.getElementById('streakDisplay').textContent = `ğŸ”¥ ${userStats.streak || 0}`;

      // Update filter buttons
      ['sunny', 'shade', 'noTerrace', 'terrace', 'all'].forEach(f => {
        const btn = document.getElementById(`filter${f.charAt(0).toUpperCase() + f.slice(1)}`);
        if (btn) {
          btn.classList.toggle('border-purple-500', currentFilter === f);
          btn.classList.toggle('scale-105', currentFilter === f);
          btn.classList.toggle('border-transparent', currentFilter !== f);
        }
      });

      // Update bar list
      updateBarList();
      
      // Update timeline components
      updateSunPath();
      updatePredictionPanel();
    }

    function updateBarList() {
      const container = document.getElementById('barList');
      const sortBy = document.getElementById('sortSelect')?.value || 'sun';
      
      let bars = getFilteredBars();
      
      // Sort based on selection
      switch(sortBy) {
        case 'distance':
          if (userLocation) {
            bars = bars.sort((a, b) => {
              const distA = getDistanceFromUser(a) || Infinity;
              const distB = getDistanceFromUser(b) || Infinity;
              return distA - distB;
            });
          }
          break;
        case 'rating':
          bars = bars.sort((a, b) => (b.rating || 0) - (a.rating || 0));
          break;
        case 'reviews':
          bars = bars.sort((a, b) => (b.reviews || 0) - (a.reviews || 0));
          break;
        case 'sun':
        default:
          bars = bars.sort((a, b) => getSunshineScore(b) - getSunshineScore(a));
      }
      
      bars = bars.slice(0, 18);

      container.innerHTML = bars.map(bar => {
        const status = getBarSunStatus(bar);
        const score = getSunshineScore(bar);
        const color = getMarkerColor(status);
        const checked = userStats.checkins.has(bar.id);
        const isSunny = status === 'sunny';
        const distance = getDistanceFromUser(bar);
        const distanceText = formatDistance(distance);

        return `
          <div onclick="showBarDetail(${bar.id})" class="bg-white rounded-xl p-4 border-2 cursor-pointer transition-all hover:scale-[1.02] hover:shadow-lg ${isSunny ? 'border-yellow-400' : 'border-gray-200'}">
            <div class="flex items-start justify-between mb-3">
              <div class="flex items-center gap-3">
                <div class="w-4 h-4 rounded-full" style="background-color: ${color}"></div>
                <div>
                  <h3 class="font-bold text-gray-800">${bar.name}</h3>
                  <p class="text-sm text-gray-500">${getStatusLabel(status)}</p>
                </div>
              </div>
              <div class="flex flex-col items-end gap-1">
                ${bar.hasTerrasse && score > 0 ? `<div class="px-2 py-1 rounded-full bg-yellow-100 text-yellow-700 text-xs font-bold">${score}%</div>` : ''}
                ${distanceText ? `<div class="px-2 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-bold">ğŸ“ ${distanceText}</div>` : ''}
              </div>
            </div>
            <div class="flex items-center gap-3 mb-3 text-sm text-gray-600">
              <span>â­ ${bar.rating || '-'}</span>
              <span>â€¢</span>
              <span>${bar.reviews || 0} avis</span>
              <span>â€¢</span>
              <span>${bar.price || 'â‚¬â‚¬'}</span>
            </div>
            <div class="flex gap-2">
              <button onclick="event.stopPropagation(); handleCheckIn(${bar.id})" ${checked ? 'disabled' : ''} class="flex-1 py-2 rounded-lg font-medium transition-all ${checked ? 'bg-green-100 text-green-600' : 'bg-purple-600 hover:bg-purple-700 text-white'}">
                ${checked ? 'âœ“ VisitÃ©' : `Check-in`}
              </button>
              <button onclick="event.stopPropagation(); openDirections(BARS_DATA.find(b => b.id === ${bar.id}))" class="px-3 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white transition-all" title="ItinÃ©raire">
                ğŸ§­
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function handleSort() {
      updateBarList();
    }

    // ==========================================
    // TIMELINE SLIDER
    // ==========================================
    let timelapseInterval = null;
    let isPlaying = false;
    
    function handleTimeSlider(minutes) {
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      
      // Set time to today at specified hour
      const now = new Date();
      currentTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, mins);
      
      updateTimeDisplay();
      createMarkers();
      updateUI();
      updateSunOverlay();
      updateSunPath();
      updatePredictionPanel();
    }
    
    function updateTimeDisplay() {
      const hours = currentTime.getHours();
      const minutes = currentTime.getMinutes();
      const sliderValue = hours * 60 + minutes;
      
      const slider = document.getElementById('timeSlider');
      if (slider) slider.value = sliderValue;
    }
    
    function updateSunPath() {
      const sun = getSunPosition(currentTime);
      const indicator = document.getElementById('sunPathIndicator');
      if (!indicator) return;
      
      // Calculate position on path (left = midnight, center = noon, right = midnight)
      const hours = currentTime.getHours() + currentTime.getMinutes() / 60;
      const leftPercent = (hours / 24) * 100;
      
      // Calculate vertical position based on altitude (-90 to 90 degrees)
      // When altitude is negative (night), sun is below horizon
      const maxAltitude = 60; // Max altitude in Paris summer
      const normalizedAlt = Math.max(-20, Math.min(maxAltitude, sun.altitude));
      const topPercent = 70 - ((normalizedAlt + 20) / (maxAltitude + 20)) * 60;
      
      indicator.style.left = `calc(${leftPercent}% - 16px)`;
      indicator.style.top = `${topPercent}%`;
      
      // Change emoji based on altitude
      if (sun.altitude < -6) {
        indicator.innerHTML = 'ğŸŒ™';
        indicator.className = 'absolute w-8 h-8 rounded-full bg-slate-600 shadow-lg shadow-slate-400/50 flex items-center justify-center text-lg transition-all duration-300';
      } else if (sun.altitude < 0) {
        indicator.innerHTML = 'ğŸŒ…';
        indicator.className = 'absolute w-8 h-8 rounded-full bg-orange-400 shadow-lg shadow-orange-400/50 flex items-center justify-center text-lg transition-all duration-300';
      } else {
        indicator.innerHTML = 'â˜€ï¸';
        indicator.className = 'absolute w-8 h-8 rounded-full bg-yellow-400 shadow-lg shadow-yellow-400/50 flex items-center justify-center text-lg transition-all duration-300';
      }
    }
    
    function updatePredictionPanel() {
      const panel = document.getElementById('predictionPanel');
      if (!panel) return;
      
      // Show predictions for key times today
      const predictions = [
        { hour: 8, label: '8h' },
        { hour: 12, label: '12h' },
        { hour: 15, label: '15h' },
        { hour: 18, label: '18h' }
      ];
      
      const now = new Date();
      
      panel.innerHTML = predictions.map(pred => {
        const predTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), pred.hour, 0);
        const oldTime = currentTime;
        currentTime = predTime;
        
        const sunnyCount = BARS_DATA.filter(b => getBarSunStatus(b) === 'sunny').length;
        const sun = getSunPosition(predTime);
        
        currentTime = oldTime;
        
        const isNow = Math.abs(now.getHours() - pred.hour) < 1;
        const isPast = now.getHours() > pred.hour;
        
        return `
          <button onclick="jumpToHour(${pred.hour})" class="p-2 rounded-lg text-center transition-all hover:scale-105 ${isNow ? 'bg-amber-400 text-white ring-2 ring-amber-500' : isPast ? 'bg-gray-100 text-gray-500' : 'bg-white text-amber-800 border border-amber-200'}">
            <div class="text-lg">${sun.altitude > 0 ? 'â˜€ï¸' : 'ğŸŒ™'}</div>
            <div class="font-bold text-sm">${pred.label}</div>
            <div class="text-xs">${sunnyCount} â˜€ï¸</div>
          </button>
        `;
      }).join('');
    }
    
    function jumpToHour(hour) {
      const now = new Date();
      currentTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, 0);
      
      updateTimeDisplay();
      createMarkers();
      updateUI();
      updateSunOverlay();
      updateSunPath();
      updatePredictionPanel();
    }
    
    function playTimelapse() {
      const btn = document.getElementById('playBtn');
      
      if (isPlaying) {
        // Stop
        clearInterval(timelapseInterval);
        isPlaying = false;
        btn.innerHTML = 'â–¶ï¸ Animer';
        btn.classList.remove('bg-red-500', 'hover:bg-red-600');
        btn.classList.add('bg-amber-500', 'hover:bg-amber-600');
      } else {
        // Start from 6am
        const now = new Date();
        currentTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 6, 0);
        
        isPlaying = true;
        btn.innerHTML = 'â¹ï¸ Stop';
        btn.classList.remove('bg-amber-500', 'hover:bg-amber-600');
        btn.classList.add('bg-red-500', 'hover:bg-red-600');
        
        timelapseInterval = setInterval(() => {
          // Advance 30 minutes per frame
          currentTime = new Date(currentTime.getTime() + 30 * 60 * 1000);
          
          // Stop at midnight
          if (currentTime.getHours() >= 23 && currentTime.getMinutes() >= 30) {
            playTimelapse(); // Toggle off
            return;
          }
          
          updateTimeDisplay();
          createMarkers();
          updateUI();
          updateSunOverlay();
          updateSunPath();
          updatePredictionPanel();
        }, 500); // Update every 500ms
      }
    }

    // ==========================================
    // INTERACTIONS
    // ==========================================
    function setFilter(filter) {
      currentFilter = filter;
      createMarkers();
      updateUI();
    }

    function handleSearch() {
      createMarkers();
      updateBarList();
    }

    function adjustTime(hours) {
      currentTime = new Date(currentTime.getTime() + hours * 3600000);
      createMarkers();
      updateUI();
      updateSunOverlay();
    }

    function resetTime() {
      currentTime = new Date();
      createMarkers();
      updateUI();
      updateSunOverlay();
    }

    function handleCheckIn(barId) {
      const bar = BARS_DATA.find(b => b.id === barId);
      if (!bar || userStats.checkins.has(barId)) return;

      const status = getBarSunStatus(bar);
      const hour = currentTime.getHours();
      
      // Basic check-in
      userStats.checkins.add(barId);
      
      // XP calculation
      let xpGain = status === 'sunny' ? 50 : 25;
      
      // Track sun/shade checkins
      if (status === 'sunny') {
        userStats.sunnyCheckins++;
      } else {
        userStats.shadeCheckins++;
      }
      
      // Track time-based checkins
      if (hour < 10) {
        userStats.earlyCheckins++;
      }
      if (hour >= 20) {
        userStats.lateCheckins++;
      }
      if (hour >= 17 && hour < 19) {
        userStats.goldenHourCheckins++;
      }
      
      // Track weather checkins
      if (weatherData && weatherData.cloudCover > 50) {
        userStats.cloudyCheckins++;
      }
      
      // Track arrondissement (extract from bar position)
      const arrond = getArrondissement(bar.lat, bar.lng);
      if (arrond) {
        userStats.arrondissements.add(arrond);
      }
      
      // Track streak
      const today = new Date().toDateString();
      if (userStats.lastCheckinDate) {
        const lastDate = new Date(userStats.lastCheckinDate);
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        
        if (lastDate.toDateString() === yesterday.toDateString()) {
          userStats.streak++;
        } else if (lastDate.toDateString() !== today) {
          userStats.streak = 1;
        }
      } else {
        userStats.streak = 1;
      }
      userStats.lastCheckinDate = today;
      userStats.maxStreak = Math.max(userStats.maxStreak || 0, userStats.streak);
      
      // Update XP and level
      userStats.xp += xpGain;
      userStats.level = Math.floor(userStats.xp / 500) + 1;

      // Check for new badges
      checkBadges();
      
      // Track daily challenge progress
      trackDailyCheckin(bar, status === 'sunny');
      
      // Haptic feedback for check-in
      triggerHaptic('success');
      
      // Update UI
      updateUI();
      updateBadgeCount();
      closeModal();
      
      // Save to localStorage
      saveUserStats();
    }
    
    function getArrondissement(lat, lng) {
      // Simplified arrondissement detection based on coordinates
      // Paris center is roughly 48.8566, 2.3522
      // Each arrondissement has approximate bounds
      const arrondissements = [
        { id: 1, minLat: 48.855, maxLat: 48.865, minLng: 2.335, maxLng: 2.350 },
        { id: 2, minLat: 48.865, maxLat: 48.875, minLng: 2.335, maxLng: 2.350 },
        { id: 3, minLat: 48.860, maxLat: 48.870, minLng: 2.350, maxLng: 2.365 },
        { id: 4, minLat: 48.850, maxLat: 48.860, minLng: 2.345, maxLng: 2.365 },
        { id: 5, minLat: 48.840, maxLat: 48.855, minLng: 2.340, maxLng: 2.360 },
        { id: 6, minLat: 48.845, maxLat: 48.858, minLng: 2.320, maxLng: 2.340 },
        { id: 7, minLat: 48.850, maxLat: 48.865, minLng: 2.290, maxLng: 2.325 },
        { id: 8, minLat: 48.865, maxLat: 48.880, minLng: 2.290, maxLng: 2.330 },
        { id: 9, minLat: 48.870, maxLat: 48.885, minLng: 2.325, maxLng: 2.350 },
        { id: 10, minLat: 48.870, maxLat: 48.885, minLng: 2.350, maxLng: 2.380 },
        { id: 11, minLat: 48.850, maxLat: 48.870, minLng: 2.365, maxLng: 2.400 },
        { id: 12, minLat: 48.830, maxLat: 48.855, minLng: 2.370, maxLng: 2.420 },
        { id: 13, minLat: 48.815, maxLat: 48.840, minLng: 2.340, maxLng: 2.380 },
        { id: 14, minLat: 48.815, maxLat: 48.840, minLng: 2.300, maxLng: 2.340 },
        { id: 15, minLat: 48.830, maxLat: 48.855, minLng: 2.270, maxLng: 2.310 },
        { id: 16, minLat: 48.845, maxLat: 48.875, minLng: 2.240, maxLng: 2.290 },
        { id: 17, minLat: 48.875, maxLat: 48.900, minLng: 2.290, maxLng: 2.330 },
        { id: 18, minLat: 48.880, maxLat: 48.900, minLng: 2.330, maxLng: 2.370 },
        { id: 19, minLat: 48.875, maxLat: 48.900, minLng: 2.370, maxLng: 2.410 },
        { id: 20, minLat: 48.855, maxLat: 48.875, minLng: 2.390, maxLng: 2.420 }
      ];
      
      for (const arr of arrondissements) {
        if (lat >= arr.minLat && lat <= arr.maxLat && lng >= arr.minLng && lng <= arr.maxLng) {
          return arr.id;
        }
      }
      return Math.floor(Math.random() * 20) + 1; // Fallback random
    }
    
    function checkBadges() {
      const newBadges = [];
      
      for (const [id, badge] of Object.entries(BADGES)) {
        if (!userStats.badges.has(id) && badge.condition(userStats)) {
          userStats.badges.add(id);
          newBadges.push(badge);
        }
      }
      
      // Show toast for new badges
      if (newBadges.length > 0) {
        showBadgeToast(newBadges[0]);
      }
    }
    
    function showBadgeToast(badge) {
      const toast = document.getElementById('badgeToast');
      document.getElementById('toastIcon').textContent = badge.icon;
      document.getElementById('toastTitle').textContent = badge.name;
      document.getElementById('toastDesc').textContent = badge.desc;
      
      toast.classList.remove('hidden');
      
      // Hide after 3 seconds
      setTimeout(() => {
        toast.classList.add('hidden');
      }, 3000);
    }
    
    function updateBadgeCount() {
      document.getElementById('badgeCount').textContent = userStats.badges.size;
    }
    
    function showBadgesModal() {
      // Update stats display
      document.getElementById('badgesUnlocked').textContent = userStats.badges.size;
      document.getElementById('totalCheckins').textContent = userStats.checkins.size;
      document.getElementById('currentStreak').textContent = userStats.streak || 0;
      document.getElementById('arrondsVisited').textContent = userStats.arrondissements.size;
      
      // Generate badges grid
      const grid = document.getElementById('badgesGrid');
      const categories = {
        'â˜€ï¸ Chasseur de Soleil': ['sun_starter', 'sun_lover', 'sun_master', 'sun_legend'],
        'â° Timing Parfait': ['early_bird', 'night_owl', 'golden_hour'],
        'ğŸ—ºï¸ Explorateur': ['explorer_5', 'explorer_10', 'explorer_20'],
        'ğŸ”¥ RÃ©gularitÃ©': ['streak_3', 'streak_7', 'streak_30'],
        'ğŸº Volume': ['first_checkin', 'regular_10', 'regular_50', 'regular_100'],
        'â­ Niveaux': ['level_5', 'level_10', 'level_20'],
        'ğŸ¯ SpÃ©ciaux': ['shade_lover', 'weather_warrior']
      };
      
      grid.innerHTML = Object.entries(categories).map(([category, badgeIds]) => `
        <div class="mb-6">
          <h3 class="font-bold text-gray-700 mb-3">${category}</h3>
          <div class="grid grid-cols-4 gap-3">
            ${badgeIds.map(id => {
              const badge = BADGES[id];
              const unlocked = userStats.badges.has(id);
              return `
                <div class="text-center p-3 rounded-xl transition-all ${unlocked ? 'bg-gradient-to-br from-amber-100 to-yellow-100 border-2 border-amber-300' : 'bg-gray-100 opacity-50'}">
                  <div class="text-3xl mb-1 ${unlocked ? '' : 'grayscale'}">${badge.icon}</div>
                  <p class="text-xs font-bold ${unlocked ? 'text-amber-800' : 'text-gray-500'}">${badge.name}</p>
                  <p class="text-[10px] ${unlocked ? 'text-amber-600' : 'text-gray-400'}">${badge.desc}</p>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `).join('');
      
      document.getElementById('badgesModal').classList.remove('hidden');
      document.getElementById('badgesModal').classList.add('flex');
    }
    
    function closeBadgesModal() {
      document.getElementById('badgesModal').classList.add('hidden');
      document.getElementById('badgesModal').classList.remove('flex');
    }
    
    function saveUserStats() {
      const data = {
        xp: userStats.xp,
        level: userStats.level,
        checkins: [...userStats.checkins],
        badges: [...userStats.badges],
        arrondissements: [...userStats.arrondissements],
        sunnyCheckins: userStats.sunnyCheckins,
        shadeCheckins: userStats.shadeCheckins,
        earlyCheckins: userStats.earlyCheckins,
        lateCheckins: userStats.lateCheckins,
        goldenHourCheckins: userStats.goldenHourCheckins,
        cloudyCheckins: userStats.cloudyCheckins,
        streak: userStats.streak,
        maxStreak: userStats.maxStreak,
        lastCheckinDate: userStats.lastCheckinDate
      };
      localStorage.setItem('spotTheSun_stats', JSON.stringify(data));
    }
    
    function loadUserStats() {
      try {
        const saved = localStorage.getItem('spotTheSun_stats');
        if (saved) {
          const data = JSON.parse(saved);
          userStats.xp = data.xp || 0;
          userStats.level = data.level || 1;
          userStats.checkins = new Set(data.checkins || []);
          userStats.badges = new Set(data.badges || []);
          userStats.arrondissements = new Set(data.arrondissements || []);
          userStats.sunnyCheckins = data.sunnyCheckins || 0;
          userStats.shadeCheckins = data.shadeCheckins || 0;
          userStats.earlyCheckins = data.earlyCheckins || 0;
          userStats.lateCheckins = data.lateCheckins || 0;
          userStats.goldenHourCheckins = data.goldenHourCheckins || 0;
          userStats.cloudyCheckins = data.cloudyCheckins || 0;
          userStats.streak = data.streak || 0;
          userStats.maxStreak = data.maxStreak || 0;
          userStats.lastCheckinDate = data.lastCheckinDate || null;
          
          updateBadgeCount();
          console.log('âœ… Stats chargÃ©es:', userStats);
        }
      } catch (e) {
        console.log('Pas de stats sauvegardÃ©es');
      }
    }

    function showBarDetail(barId) {
      const bar = BARS_DATA.find(b => b.id === barId);
      if (!bar) return;

      const status = getBarSunStatus(bar);
      const score = getSunshineScore(bar);
      const color = getMarkerColor(status);
      const checked = userStats.checkins.has(barId);
      const distance = getDistanceFromUser(bar);
      const distanceText = formatDistance(distance);
      
      // Get sunshine forecast for this bar
      const forecast = getBarSunshineForecast(bar);

      document.getElementById('modalContent').innerHTML = `
        <div class="p-6">
          <div class="flex items-start justify-between mb-4">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">${bar.name}</h2>
              <p class="text-gray-500">${getStatusLabel(status)}</p>
            </div>
            <button onclick="closeModal()" class="p-2 rounded-lg hover:bg-gray-100">
              <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
          </div>
          
          ${distanceText ? `
          <div class="flex items-center gap-3 p-3 rounded-xl bg-blue-50 border border-blue-200 mb-4">
            <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white">ğŸ“</div>
            <div class="flex-1">
              <p class="font-bold text-blue-800">${distanceText}</p>
              <p class="text-xs text-blue-600">de votre position</p>
            </div>
            <button onclick="openDirections(BARS_DATA.find(b => b.id === ${bar.id}))" class="px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white font-medium transition-all flex items-center gap-2">
              ğŸ§­ Y aller
            </button>
          </div>
          ` : ''}
          
          <div class="p-4 rounded-xl mb-4 ${status === 'sunny' ? 'bg-gradient-to-r from-yellow-100 to-orange-100' : 'bg-gray-100'}">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-full flex items-center justify-center text-white text-xl" style="background-color: ${color}">
                ${status === 'sunny' ? 'â˜€ï¸' : (bar.hasTerrasse ? 'ğŸŒ¥ï¸' : 'ğŸ ')}
              </div>
              <div>
                <p class="font-bold text-gray-800">
                  ${bar.hasTerrasse ? (status === 'sunny' ? 'Terrasse au soleil !' : 'Terrasse Ã  l\'ombre') : 'Pas de terrasse'}
                </p>
                ${bar.hasTerrasse ? `<p class="text-sm text-gray-600">Score ensoleillement: ${score}%</p>` : ''}
              </div>
            </div>
          </div>
          
          ${bar.hasTerrasse ? `
          <!-- Sunshine forecast -->
          <div class="mb-4 p-3 rounded-xl bg-gradient-to-r from-amber-50 to-yellow-50 border border-amber-200">
            <p class="text-sm font-bold text-amber-800 mb-2">â˜€ï¸ PrÃ©vision ensoleillement aujourd'hui</p>
            <div class="flex gap-1">
              ${forecast.map(f => `
                <div class="flex-1 text-center p-1 rounded ${f.status === 'sunny' ? 'bg-yellow-400' : f.status === 'partial' ? 'bg-orange-300' : f.status === 'night' ? 'bg-slate-600' : 'bg-blue-300'}">
                  <div class="text-xs font-medium ${f.status === 'night' ? 'text-white' : 'text-gray-800'}">${f.hour}h</div>
                </div>
              `).join('')}
            </div>
            <p class="text-xs text-amber-600 mt-2">
              ${forecast.filter(f => f.status === 'sunny').length > 0 
                ? `ğŸŒŸ Au soleil de ${forecast.filter(f => f.status === 'sunny')[0]?.hour || '-'}h Ã  ${forecast.filter(f => f.status === 'sunny').slice(-1)[0]?.hour || '-'}h`
                : 'â˜ï¸ Pas de soleil direct prÃ©vu aujourd\'hui'}
            </p>
          </div>
          ` : ''}
          
          <div class="grid grid-cols-3 gap-3 mb-4">
            <div class="text-center p-3 rounded-xl bg-gray-100">
              <div class="text-yellow-500 text-lg mb-1">â­</div>
              <p class="font-bold text-gray-800">${bar.rating || '-'}</p>
              <p class="text-xs text-gray-500">Note</p>
            </div>
            <div class="text-center p-3 rounded-xl bg-gray-100">
              <div class="text-blue-500 text-lg mb-1">ğŸ’¬</div>
              <p class="font-bold text-gray-800">${bar.reviews || 0}</p>
              <p class="text-xs text-gray-500">Avis</p>
            </div>
            <div class="text-center p-3 rounded-xl bg-gray-100">
              <div class="text-orange-500 text-lg mb-1">ğŸ’°</div>
              <p class="font-bold text-gray-800">${bar.price || 'â‚¬â‚¬'}</p>
              <p class="text-xs text-gray-500">Prix</p>
            </div>
          </div>
          
          <button onclick="handleCheckIn(${bar.id})" ${checked ? 'disabled' : ''} class="w-full py-3 rounded-xl font-bold transition-all ${checked ? 'bg-green-100 text-green-600' : 'bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white shadow-lg'}">
            ${checked ? 'âœ“ DÃ©jÃ  visitÃ©' : `Check-in (+${status === 'sunny' ? 50 : 25} XP)`}
          </button>
        </div>
      `;

      document.getElementById('barModal').classList.remove('hidden');
      document.getElementById('barModal').classList.add('flex');
    }
    
    function getBarSunshineForecast(bar) {
      if (!bar.hasTerrasse) return [];
      
      const now = new Date();
      const forecast = [];
      
      for (let hour = 7; hour <= 21; hour++) {
        const predTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, 0);
        const oldTime = currentTime;
        currentTime = predTime;
        
        const status = getBarSunStatus(bar);
        
        currentTime = oldTime;
        
        forecast.push({ hour, status });
      }
      
      return forecast;
    }

    function closeModal() {
      document.getElementById('barModal').classList.add('hidden');
      document.getElementById('barModal').classList.remove('flex');
    }

    // Close modal on backdrop click
    document.getElementById('barModal').addEventListener('click', (e) => {
      if (e.target.id === 'barModal') closeModal();
    });

    document.getElementById('badgesModal').addEventListener('click', (e) => {
      if (e.target.id === 'badgesModal') closeBadgesModal();
    });

    // ==========================================
    // ONBOARDING
    // ==========================================
    let currentOnboardingSlide = 0;
    const totalSlides = 3;
    
    function showOnboarding() {
      // Check if user has seen onboarding before
      if (localStorage.getItem('spotTheSun_onboardingDone')) {
        return;
      }
      
      const modal = document.getElementById('onboardingModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      currentOnboardingSlide = 0;
      updateOnboardingUI();
    }
    
    function nextOnboardingSlide() {
      const currentSlide = document.querySelector(`.onboarding-slide[data-slide="${currentOnboardingSlide}"]`);
      
      if (currentOnboardingSlide < totalSlides - 1) {
        // Animate out current slide
        currentSlide.classList.add('slide-out');
        
        setTimeout(() => {
          currentSlide.classList.add('hidden');
          currentSlide.classList.remove('slide-out');
          
          currentOnboardingSlide++;
          
          // Show next slide
          const nextSlide = document.querySelector(`.onboarding-slide[data-slide="${currentOnboardingSlide}"]`);
          nextSlide.classList.remove('hidden');
          nextSlide.classList.add('slide-in');
          
          setTimeout(() => nextSlide.classList.remove('slide-in'), 400);
          
          updateOnboardingUI();
        }, 300);
      } else {
        // Last slide - finish onboarding
        finishOnboarding();
      }
    }
    
    function skipOnboarding() {
      finishOnboarding();
    }
    
    function finishOnboarding() {
      localStorage.setItem('spotTheSun_onboardingDone', 'true');
      
      const modal = document.getElementById('onboardingModal');
      modal.style.transition = 'opacity 0.5s ease-out';
      modal.style.opacity = '0';
      
      setTimeout(() => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        modal.style.opacity = '1';
      }, 500);
    }
    
    function updateOnboardingUI() {
      // Update dots
      document.querySelectorAll('.onboarding-dot').forEach((dot, index) => {
        if (index === currentOnboardingSlide) {
          dot.classList.remove('bg-white/40');
          dot.classList.add('bg-white', 'w-6');
        } else {
          dot.classList.add('bg-white/40');
          dot.classList.remove('bg-white', 'w-6');
          dot.classList.add('w-2');
        }
      });
      
      // Update button text
      const nextBtn = document.getElementById('onboardingNext');
      if (currentOnboardingSlide === totalSlides - 1) {
        nextBtn.textContent = "C'est parti ! â˜€ï¸";
      } else {
        nextBtn.textContent = 'Suivant â†’';
      }
    }
    
    // Reset onboarding (for testing)
    function resetOnboarding() {
      localStorage.removeItem('spotTheSun_onboardingDone');
      location.reload();
    }
    
    // Swipe support for onboarding
    let touchStartX = 0;
    let touchEndX = 0;
    
    document.addEventListener('touchstart', (e) => {
      if (document.getElementById('onboardingModal').classList.contains('flex')) {
        touchStartX = e.changedTouches[0].screenX;
      }
    });
    
    document.addEventListener('touchend', (e) => {
      if (document.getElementById('onboardingModal').classList.contains('flex')) {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
      }
    });
    
    function handleSwipe() {
      const swipeThreshold = 50;
      const diff = touchStartX - touchEndX;
      
      if (diff > swipeThreshold) {
        // Swipe left - next slide
        nextOnboardingSlide();
      } else if (diff < -swipeThreshold && currentOnboardingSlide > 0) {
        // Swipe right - previous slide (optional)
        prevOnboardingSlide();
      }
    }
    
    function prevOnboardingSlide() {
      if (currentOnboardingSlide <= 0) return;
      
      const currentSlide = document.querySelector(`.onboarding-slide[data-slide="${currentOnboardingSlide}"]`);
      currentSlide.classList.add('hidden');
      
      currentOnboardingSlide--;
      
      const prevSlide = document.querySelector(`.onboarding-slide[data-slide="${currentOnboardingSlide}"]`);
      prevSlide.classList.remove('hidden');
      
      updateOnboardingUI();
    }

    // ==========================================
    // MOBILE BOTTOM SHEET
    // ==========================================
    let bottomSheetOpen = false;
    let bottomSheetView = 'list'; // 'list' or 'swipe'
    let swipeCardIndex = 0;
    let swipeCardBars = [];
    
    function openBottomSheet() {
      const sheet = document.getElementById('bottomSheet');
      sheet.classList.add('open');
      bottomSheetOpen = true;
      document.body.style.overflow = 'hidden';
      updateBottomSheet();
      triggerHaptic('light');
    }
    
    function closeBottomSheet() {
      const sheet = document.getElementById('bottomSheet');
      sheet.classList.remove('open');
      bottomSheetOpen = false;
      document.body.style.overflow = '';
      triggerHaptic('light');
    }
    
    function updateBottomSheet() {
      const bars = getFilteredBars();
      const sortBy = document.getElementById('sortSelect')?.value || 'sun';
      
      let sortedBars = [...bars];
      switch(sortBy) {
        case 'distance':
          if (userLocation) {
            sortedBars.sort((a, b) => (getDistanceFromUser(a) || Infinity) - (getDistanceFromUser(b) || Infinity));
          }
          break;
        case 'rating':
          sortedBars.sort((a, b) => (b.rating || 0) - (a.rating || 0));
          break;
        default:
          sortedBars.sort((a, b) => getSunshineScore(b) - getSunshineScore(a));
      }
      
      // Update count
      document.getElementById('bottomSheetCount').textContent = `${sortedBars.length} rÃ©sultats`;
      
      // Update list view
      const listContainer = document.getElementById('bottomSheetList');
      listContainer.innerHTML = sortedBars.slice(0, 20).map(bar => {
        const status = getBarSunStatus(bar);
        const score = getSunshineScore(bar);
        const color = getMarkerColor(status);
        const distance = getDistanceFromUser(bar);
        const distanceText = formatDistance(distance);
        const isSunny = status === 'sunny';
        
        return `
          <div onclick="showBarDetail(${bar.id}); closeBottomSheet();" class="flex items-center gap-3 p-3 mb-2 rounded-xl bg-gray-50 active:bg-gray-100 transition cursor-pointer ${isSunny ? 'ring-2 ring-yellow-400' : ''}">
            <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-lg" style="background-color: ${color}">
              ${isSunny ? 'â˜€ï¸' : (bar.hasTerrasse ? 'ğŸŒ¥ï¸' : 'ğŸ ')}
            </div>
            <div class="flex-1 min-w-0">
              <p class="font-bold text-gray-800 truncate">${bar.name}</p>
              <div class="flex items-center gap-2 text-xs text-gray-500">
                <span>â­ ${bar.rating || '-'}</span>
                ${distanceText ? `<span>ğŸ“ ${distanceText}</span>` : ''}
                ${bar.hasTerrasse && score > 0 ? `<span class="text-yellow-600 font-medium">${score}%</span>` : ''}
              </div>
            </div>
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
          </div>
        `;
      }).join('');
      
      // Update swipe cards
      swipeCardBars = sortedBars.slice(0, 20);
      swipeCardIndex = 0;
      renderSwipeCards();
    }
    
    function toggleBottomSheetView(view) {
      bottomSheetView = view;
      
      document.getElementById('bottomSheetList').classList.toggle('hidden', view !== 'list');
      document.getElementById('swipeCardsContainer').classList.toggle('hidden', view !== 'swipe');
      
      document.getElementById('viewListBtn').classList.toggle('bg-amber-500', view === 'list');
      document.getElementById('viewListBtn').classList.toggle('text-white', view === 'list');
      document.getElementById('viewListBtn').classList.toggle('bg-gray-100', view !== 'list');
      document.getElementById('viewListBtn').classList.toggle('text-gray-700', view !== 'list');
      
      document.getElementById('viewSwipeBtn').classList.toggle('bg-amber-500', view === 'swipe');
      document.getElementById('viewSwipeBtn').classList.toggle('text-white', view === 'swipe');
      document.getElementById('viewSwipeBtn').classList.toggle('bg-gray-100', view !== 'swipe');
      document.getElementById('viewSwipeBtn').classList.toggle('text-gray-700', view !== 'swipe');
      
      if (view === 'swipe') {
        renderSwipeCards();
      }
      
      triggerHaptic('light');
    }
    
    // ==========================================
    // SWIPE CARDS (Tinder-style)
    // ==========================================
    function renderSwipeCards() {
      const container = document.getElementById('swipeCards');
      container.innerHTML = '';
      
      // Render up to 3 cards (stacked)
      for (let i = Math.min(swipeCardIndex + 2, swipeCardBars.length - 1); i >= swipeCardIndex; i--) {
        const bar = swipeCardBars[i];
        if (!bar) continue;
        
        const status = getBarSunStatus(bar);
        const score = getSunshineScore(bar);
        const color = getMarkerColor(status);
        const distance = getDistanceFromUser(bar);
        const distanceText = formatDistance(distance);
        const isTop = i === swipeCardIndex;
        const offset = i - swipeCardIndex;
        
        const card = document.createElement('div');
        card.className = 'swipe-card';
        card.style.zIndex = 10 - offset;
        card.style.transform = `scale(${1 - offset * 0.05}) translateY(${offset * 10}px)`;
        card.dataset.barId = bar.id;
        
        card.innerHTML = `
          <div class="swipe-card-overlay left">ğŸ‘</div>
          <div class="swipe-card-overlay right">â˜€ï¸</div>
          <div class="h-full flex flex-col">
            <div class="flex-1 flex items-center justify-center text-6xl" style="background: linear-gradient(135deg, ${color}33, ${color}11)">
              ${status === 'sunny' ? 'â˜€ï¸' : (bar.hasTerrasse ? 'ğŸŒ¥ï¸' : 'ğŸ ')}
            </div>
            <div class="p-4">
              <h3 class="font-bold text-xl text-gray-800 mb-1">${bar.name}</h3>
              <p class="text-sm text-gray-500 mb-3">${getStatusLabel(status)} ${bar.hasTerrasse && score > 0 ? `Â· ${score}%` : ''}</p>
              <div class="flex items-center gap-4 text-sm text-gray-600">
                <span>â­ ${bar.rating || '-'}</span>
                <span>ğŸ’¬ ${bar.reviews || 0}</span>
                ${distanceText ? `<span>ğŸ“ ${distanceText}</span>` : ''}
              </div>
            </div>
          </div>
        `;
        
        if (isTop) {
          setupSwipeGestures(card);
        }
        
        container.appendChild(card);
      }
      
      // Check if no more cards
      if (swipeCardIndex >= swipeCardBars.length) {
        container.innerHTML = `
          <div class="h-full flex flex-col items-center justify-center text-gray-400">
            <div class="text-6xl mb-4">ğŸ‰</div>
            <p class="font-medium">Plus de bars Ã  voir !</p>
            <button onclick="swipeCardIndex = 0; renderSwipeCards();" class="mt-4 px-4 py-2 bg-amber-500 text-white rounded-lg font-medium">Recommencer</button>
          </div>
        `;
      }
    }
    
    function setupSwipeGestures(card) {
      let startX = 0;
      let currentX = 0;
      let isDragging = false;
      
      const onStart = (e) => {
        isDragging = true;
        startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
        card.style.transition = 'none';
      };
      
      const onMove = (e) => {
        if (!isDragging) return;
        currentX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
        const diff = currentX - startX;
        const rotation = diff * 0.1;
        
        card.style.transform = `translateX(${diff}px) rotate(${rotation}deg)`;
        
        card.classList.toggle('dragging-left', diff < -50);
        card.classList.toggle('dragging-right', diff > 50);
      };
      
      const onEnd = () => {
        if (!isDragging) return;
        isDragging = false;
        
        const diff = currentX - startX;
        card.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
        
        if (diff < -100) {
          swipeCard('left', card);
        } else if (diff > 100) {
          swipeCard('right', card);
        } else {
          card.style.transform = '';
          card.classList.remove('dragging-left', 'dragging-right');
        }
      };
      
      card.addEventListener('mousedown', onStart);
      card.addEventListener('mousemove', onMove);
      card.addEventListener('mouseup', onEnd);
      card.addEventListener('mouseleave', onEnd);
      
      card.addEventListener('touchstart', onStart, { passive: true });
      card.addEventListener('touchmove', onMove, { passive: true });
      card.addEventListener('touchend', onEnd);
    }
    
    function swipeCard(direction, card = null) {
      if (!card) {
        card = document.querySelector('.swipe-card[style*="z-index: 10"]');
      }
      if (!card) return;
      
      triggerHaptic(direction === 'right' ? 'medium' : 'light');
      
      card.classList.add(direction === 'left' ? 'swiping-left' : 'swiping-right');
      
      if (direction === 'right') {
        // Show bar detail
        const barId = parseInt(card.dataset.barId);
        setTimeout(() => {
          showBarDetail(barId);
        }, 200);
      }
      
      setTimeout(() => {
        swipeCardIndex++;
        renderSwipeCards();
      }, 300);
    }
    
    // ==========================================
    // HAPTIC FEEDBACK
    // ==========================================
    function triggerHaptic(intensity = 'light') {
      if (!navigator.vibrate) return;
      
      switch(intensity) {
        case 'light':
          navigator.vibrate(10);
          break;
        case 'medium':
          navigator.vibrate(25);
          break;
        case 'heavy':
          navigator.vibrate([30, 20, 30]);
          break;
        case 'success':
          navigator.vibrate([10, 50, 30]);
          break;
        case 'error':
          navigator.vibrate([50, 30, 50, 30, 50]);
          break;
      }
    }
    
    // ==========================================
    // PULL TO REFRESH
    // ==========================================
    let pullStartY = 0;
    let isPulling = false;
    let pullDistance = 0;
    const PULL_THRESHOLD = 80;
    
    function setupPullToRefresh() {
      const listContainer = document.getElementById('bottomSheetList');
      if (!listContainer) return;
      
      listContainer.addEventListener('touchstart', (e) => {
        if (listContainer.scrollTop === 0) {
          pullStartY = e.touches[0].clientY;
          isPulling = true;
        }
      }, { passive: true });
      
      listContainer.addEventListener('touchmove', (e) => {
        if (!isPulling) return;
        
        pullDistance = e.touches[0].clientY - pullStartY;
        
        if (pullDistance > 0 && pullDistance < PULL_THRESHOLD * 2) {
          const indicator = document.getElementById('pullToRefreshIndicator');
          indicator.classList.remove('hidden');
          indicator.classList.add('flex');
          indicator.style.opacity = Math.min(pullDistance / PULL_THRESHOLD, 1);
        }
      }, { passive: true });
      
      listContainer.addEventListener('touchend', () => {
        if (isPulling && pullDistance > PULL_THRESHOLD) {
          // Trigger refresh
          triggerHaptic('medium');
          performRefresh();
        } else {
          hideRefreshIndicator();
        }
        
        isPulling = false;
        pullDistance = 0;
      });
    }
    
    function performRefresh() {
      const indicator = document.getElementById('pullToRefreshIndicator');
      indicator.innerHTML = `
        <svg class="w-6 h-6 animate-spin mr-2" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
        </svg>
        <span class="text-sm font-medium">Actualisation...</span>
      `;
      
      // Refresh data
      setTimeout(() => {
        fetchWeather();
        createMarkers();
        updateUI();
        updateBottomSheet();
        
        triggerHaptic('success');
        hideRefreshIndicator();
      }, 1000);
    }
    
    function hideRefreshIndicator() {
      const indicator = document.getElementById('pullToRefreshIndicator');
      indicator.classList.add('hidden');
      indicator.classList.remove('flex');
      indicator.style.opacity = 0;
    }

    // ==========================================
    // PWA INSTALLATION
    // ==========================================
    let deferredPrompt = null;
    
    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const registration = await navigator.serviceWorker.register('sw.js');
          console.log('â˜€ï¸ Service Worker registered:', registration.scope);
          
          // Check for updates
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                // New version available
                showUpdateNotification();
              }
            });
          });
        } catch (error) {
          console.log('â˜€ï¸ Service Worker registration failed:', error);
        }
      });
    }
    
    // Capture install prompt
    window.addEventListener('beforeinstallprompt', (e) => {
      console.log('â˜€ï¸ Install prompt captured');
      e.preventDefault();
      deferredPrompt = e;
      
      // Show install button in header
      const installBtn = document.getElementById('installBtn');
      if (installBtn) {
        installBtn.classList.remove('hidden');
        installBtn.classList.add('flex');
      }
      
      // Show install banner on mobile (after 5 seconds)
      if (window.innerWidth < 768) {
        setTimeout(() => {
          const banner = document.getElementById('installBanner');
          const dismissed = localStorage.getItem('installBannerDismissed');
          if (banner && !dismissed) {
            banner.classList.remove('hidden');
          }
        }, 5000);
      }
    });
    
    function dismissInstallBanner() {
      const banner = document.getElementById('installBanner');
      if (banner) {
        banner.classList.add('hidden');
        localStorage.setItem('installBannerDismissed', Date.now());
      }
    }
    
    // Handle app installed
    window.addEventListener('appinstalled', (e) => {
      console.log('â˜€ï¸ App installed successfully');
      deferredPrompt = null;
      
      // Hide install button
      const installBtn = document.getElementById('installBtn');
      if (installBtn) {
        installBtn.classList.add('hidden');
        installBtn.classList.remove('flex');
      }
      
      // Show success message
      showInstallSuccessToast();
    });
    
    async function installPWA() {
      if (!deferredPrompt) {
        console.log('â˜€ï¸ No install prompt available');
        // Show manual install instructions
        showManualInstallInstructions();
        return;
      }
      
      // Show the install prompt
      deferredPrompt.prompt();
      
      // Wait for user response
      const { outcome } = await deferredPrompt.userChoice;
      console.log('â˜€ï¸ User choice:', outcome);
      
      deferredPrompt = null;
    }
    
    function showInstallSuccessToast() {
      const toast = document.getElementById('badgeToast');
      document.getElementById('toastIcon').textContent = 'ğŸ“²';
      document.getElementById('toastTitle').textContent = 'Application installÃ©e !';
      document.getElementById('toastDesc').textContent = 'Spot The Sun est maintenant sur ton Ã©cran d\'accueil';
      
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 4000);
    }
    
    function showManualInstallInstructions() {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isAndroid = /Android/.test(navigator.userAgent);
      
      let instructions = '';
      if (isIOS) {
        instructions = 'ğŸ“± Sur iOS:\n1. Appuie sur le bouton Partager (â¬†ï¸)\n2. Choisis "Sur l\'Ã©cran d\'accueil"\n3. Appuie sur "Ajouter"';
      } else if (isAndroid) {
        instructions = 'ğŸ“± Sur Android:\n1. Appuie sur le menu (â‹®)\n2. Choisis "Ajouter Ã  l\'Ã©cran d\'accueil"\n3. Confirme l\'ajout';
      } else {
        instructions = 'ğŸ’» Sur ordinateur:\n1. Clique sur l\'icÃ´ne d\'installation dans la barre d\'adresse\n2. Ou utilise le menu du navigateur';
      }
      
      alert(instructions);
    }
    
    function showUpdateNotification() {
      if (confirm('â˜€ï¸ Nouvelle version disponible ! Recharger pour mettre Ã  jour ?')) {
        window.location.reload();
      }
    }
    
    // Check if running as installed PWA
    function isPWA() {
      return window.matchMedia('(display-mode: standalone)').matches || 
             window.navigator.standalone === true;
    }
    
    // Handle URL parameters (from PWA shortcuts)
    function handleURLParams() {
      const params = new URLSearchParams(window.location.search);
      
      if (params.get('filter') === 'sunny') {
        setFilter('sunny');
      }
      
      if (params.get('sort') === 'distance') {
        document.getElementById('sortSelect').value = 'distance';
        handleSort();
      }
    }
    
    // Call on load
    window.addEventListener('load', handleURLParams);
    
    // Show onboarding for new users
    window.addEventListener('load', () => {
      setTimeout(showOnboarding, 500);
      setupPullToRefresh();
      initDailyChallenges();
    });
    
    // Offline detection
    function updateOnlineStatus() {
      const indicator = document.getElementById('offlineIndicator');
      if (!navigator.onLine) {
        indicator?.classList.remove('hidden');
      } else {
        indicator?.classList.add('hidden');
      }
    }
    
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    window.addEventListener('load', updateOnlineStatus);

    // Initialize
    window.initMap = initMap;
  </script>

  <!-- Google Maps API -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAFF0Qk3gQkkyBt3mcPnfmwl7hDHXmVtBo&callback=initMap&libraries=visualization"></script>
  
  <!-- MarkerClusterer Library -->
  <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
</body>
</html>
